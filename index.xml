<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>jason's åšå®¢</title><link>https://jasonrd.github.io/blog/</link><description>Recent content on jason's åšå®¢</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sat, 28 May 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://jasonrd.github.io/blog/index.xml" rel="self" type="application/rss+xml"/><item><title>Archives</title><link>https://jasonrd.github.io/blog/archives/</link><pubDate>Sat, 28 May 2022 00:00:00 +0000</pubDate><guid>https://jasonrd.github.io/blog/archives/</guid><description/></item><item><title>ä» kubectl exec å¼‚å¸¸é—®é¢˜å¼€å§‹</title><link>https://jasonrd.github.io/blog/p/kubectl-exec-deepin/</link><pubDate>Tue, 01 Mar 2022 00:00:00 +0000</pubDate><guid>https://jasonrd.github.io/blog/p/kubectl-exec-deepin/</guid><description>&lt;img src="https://jasonrd.github.io/blog/p/kubectl-exec-deepin/helena-hertz-wWZzXlDpMog-unsplash.jpg" alt="Featured image of post ä» kubectl exec å¼‚å¸¸é—®é¢˜å¼€å§‹" />&lt;h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡&lt;/h2>
&lt;p>æœ€è¿‘ï¼Œåœ¨å·¥ä½œæƒ³è¦ä½¿ç”¨ kubectl exec è¿›å…¥å®¹å™¨æ’æŸ¥é—®é¢˜ï¼Œç»“æœè¿”å›ä¸‹é¢å¼‚å¸¸ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-failure.png"
width="2828"
height="158"
srcset="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-failure_hufe0606b0bd44839a8e6bff7d797c72f2_189000_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-failure_hufe0606b0bd44839a8e6bff7d797c72f2_189000_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="1789"
data-flex-basis="4295px"
>&lt;/p>
&lt;h2 id="æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹&lt;/h2>
&lt;p>æˆ‘ä»¬çŸ¥é“ kubectl exec çš„æ‰§è¡Œé“¾è·¯æ˜¯ client -&amp;gt; kube-apiserver -&amp;gt; kubelet -&amp;gt; dockerã€‚&lt;/p>
&lt;p>ç™»å½• Kubelet å®¿ä¸»æœºæŸ¥çœ‹ kubelet é”™è¯¯æ—¥å¿—ï¼Œå‘ç°æœ‰ç›¸åŒçš„æŠ¥é”™æ—¥å¿—ï¼Œè¿™è¯´æ˜æ˜¯ kubelet å’Œ docker ä¹‹é—´é“¾è·¯åˆé—®é¢˜ã€‚é€šè¿‡ kubelet æ—¥å¿—ä¸­ä¸èƒ½å®šä¸ºåˆ°é—®é¢˜å…·ä½“åŸå› ã€‚ç„¶åï¼Œæˆ‘ä»¬è¯•å›¾é€šè¿‡æŠ“åŒ…ï¼Œå¸Œæœ›åœ¨æ•°æ®åŒ…ä¸­èƒ½å‘ç°ä¸€äº›çº¿ç´¢ã€‚&lt;/p>
&lt;p>åœ¨æŠ“åŒ…æ•°æ®ç»“æœä¸­æˆ‘ä»¬å‘ç°å…³é”®å­—ä¸º exec çš„è¯·æ±‚ï¼Œè¯¥ä¼šè¯çš„ç›®çš„åœ°å€ä¸º A:20880, http header ä¸­ Host ä¸º B:10250 ï¼ˆä¹Ÿå°±æ˜¯æ˜¯ç‰©ç†æœºä¸Š kubelet çš„ httpserver åœ°å€ï¼‰ã€‚æˆ‘ä»¬æŸ¥è¯¢ A è¿™ä¸ªIPï¼Œå‘ç°æ˜¯ä¸šåŠ¡åº”ç”¨çš„å®¹å™¨ IPã€‚&lt;/p>
&lt;p>è¿™å°±æ¯”è¾ƒå¥‡æ€ªäº†ï¼Œæ­£å¸¸ apiserver å‘é€ exec è¯·æ±‚ä¸ºä»€ä¹ˆè½¬å‘åˆ°äº†å®¹å™¨çš„ 20880 ç«¯å£ã€‚å¹¶ä¸”æ•°æ®åŒ…ä¸­åŒ…å« kubectl (&amp;ldquo;User-Agent: kubectl&amp;rdquo;) http headerã€‚éš¾é“ kubectl exec è¯·æ±‚å‘é€åˆ° docker çš„è¯·æ±‚ï¼ˆxxxx/exec/tokenï¼‰è¢«è½¬å‘åˆ°äº†å®¹å™¨ã€‚é€šè¿‡å†æ¬¡å°è¯•æ‰§è¡Œ kubectl exec å¹¶æŠ“åŒ…ï¼Œå‘ç°æ‰§è¡Œå‘½ä»¤å’Œå‘é€åˆ° 20880 ç«¯å£è¯·æ±‚åŒ¹é…ï¼Œè¿™éªŒè¯äº†æˆ‘ä»¬çš„çŒœæµ‹ã€‚&lt;/p>
&lt;p>åˆ°æ­¤å°±æŠŠé—®é¢˜èŒƒå›´ç¼©å°åˆ°å®¿ä¸»æœºç½‘ç»œä¸Šï¼Œæˆ‘ä»¬çŸ¥é“ kube-proxy ä¼šé€šè¿‡ ipvs æˆ– iptables å¯¹åˆ›å»ºçš„ nodeport æˆ– service vip çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªå’Œè½¬å‘ã€‚æˆ‘ä»¬æŸ¥çœ‹ conntrack è¯·æ±‚è®°å½•ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-conntrack.png"
width="2706"
height="64"
srcset="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-conntrack_huca2d8b10dc5e6cf266293d7184a5d6ec_84921_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-conntrack_huca2d8b10dc5e6cf266293d7184a5d6ec_84921_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="4228"
data-flex-basis="10147px"
>&lt;/p>
&lt;p>å‘ç°ä¸€æ¡è¯·æ±‚ 127.0.0.1:33589 çš„è®°å½•ï¼Œå¹¶ä¸”è½¬å‘åˆ°çš„åœ°å€ A:20880 ä¹Ÿå’Œæˆ‘ä»¬æŠ“åŒ…çš„ç»“æœåŒ¹é…ã€‚ç„¶åæŸ¥çœ‹ 33589 ç«¯å£ï¼Œå‘ç°è¯¥ç«¯å£å°±æ˜¯è¢« kubelet å ç”¨ã€‚ç„¶åï¼Œæˆ‘ä»¬æŸ¥è¯¢ serviceï¼Œå‘ç° 33589 ç«¯å£åŒæ—¶æ˜¯ B å®¹å™¨çš„åº”ç”¨ service çš„ nodeportã€‚åˆ°æ­¤é—®é¢˜æ ¹æœ¬åŸå› å®šä½åˆ°äº†ï¼Œnodeport ç«¯å£å’Œ kubelet å¯åŠ¨çš„è½¬å‘ç«¯å£å†²çªäº†ï¼Œå¯¼è‡´å‘é€ exec è¯·æ±‚è½¬å‘åˆ°äº†åº”ç”¨å®¹å™¨çš„ 20880 ç«¯å£ï¼ˆdubboç«¯å£ï¼‰ã€‚&lt;/p>
&lt;h2 id="ç»§ç»­æ·±æŒ–">ç»§ç»­æ·±æŒ–&lt;/h2>
&lt;p>äº‹æƒ…åˆ°æ­¤å¹¶æ²¡æœ‰ç»“æŸï¼Œä¸Šé¢æˆ‘ä»¬åªæ˜¯å®šä½åˆ°äº†å…·ä½“é—®é¢˜åŸå› ã€‚å…¶å®è¿˜å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>å¯¹ kubectl exec çš„æ‰§è¡Œè¿‡ç¨‹è¿˜æ²¡æ²¡æŒ–é€ï¼›&lt;/li>
&lt;li>å¦‚ä½•é¿å…è¯¥é—®é¢˜ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;h3 id="kubectl-exec-çš„æ‰§è¡Œè¿‡ç¨‹">kubectl exec çš„æ‰§è¡Œè¿‡ç¨‹&lt;/h3>
&lt;p>é—®é¢˜æ²¡æœ‰å¿«é€Ÿå®šä½ï¼Œä¸»è¦åŸå› è¿˜æ˜¯å¯¹ kubectl exec æ‰§è¡Œæµç¨‹ä¸ç†Ÿã€‚ä¸‹é¢æ¥äº†è§£ä¸€ä¸‹ kubectl æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚&lt;/p>
&lt;p>æœ¬æ–‡åŸºäº 1.14.6 æºç è¿›è¡Œç ”ç©¶ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œç®€å•äº†è§£ä¸€ä¸‹ kubelet æ¶æ„ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-arch.png"
width="1576"
height="368"
srcset="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-arch_hu6568dec694f664b38c0d8a13d58d2338_47592_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-arch_hu6568dec694f664b38c0d8a13d58d2338_47592_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="428"
data-flex-basis="1027px"
>&lt;/p>
&lt;p>kubelet ä¸­æœ‰ä¸Šé¢å‡ ä¸ªéƒ¨åˆ†ï¼šcontainer managerã€dockershimã€http serverã€streaming serverã€‚kubelet æ—©æœŸç›´æ¥è°ƒç”¨ docker api ç®¡ç†å®¹å™¨ï¼Œåæ¥ä¸ºäº†é€‚é…æ›´å¤šçš„ runtime æŠ½è±¡å‡ºäº†ä¸€ä¸ªæ¥å…¥å±‚ criã€‚åŒæ—¶ï¼Œä¸ºäº†å…¼å®¹ docker çš„ APIï¼Œkubelet ä»£ç ä¸­å®ç°äº†è¿™ä¸ªå« dockershim çš„éƒ¨åˆ†ã€‚è¿™æ ·å°±å¯¹ä¸Šå±‚å±è”½äº†åº•å±‚ runtimeã€‚http server é€šå¸¸ä½¿ç”¨ 10250 å¯¹å¤–æä¾› API æœåŠ¡ã€‚streaming server æ˜¯éœ€è¦å’Œå®¹å™¨è¿›è¡Œäº¤äº’æ—¶çš„ä¸€ä¸ªä»£ç†æœåŠ¡ã€‚&lt;/p>
&lt;p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ‰§è¡Œ kubectl exec ç®€åŒ–æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-streamer.png"
width="1494"
height="1000"
srcset="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-streamer_hu77ee1ab196b176433e041293050f2664_131743_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-streamer_hu77ee1ab196b176433e041293050f2664_131743_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="149"
data-flex-basis="358px"
>&lt;/p>
&lt;ol>
&lt;li>terminal ä¸­é”®å…¥ kubectl exec xxx æŒ‡ä»¤ï¼Œkubectl å‘é€è¯·æ±‚åˆ° apiserver https://apiserver/api/v1/namespaces/{ns}/pods/{pod}/exec?command=bash&amp;amp;container=dragon-claw&amp;amp;stdin=true&amp;amp;stdout=true&amp;amp;tty=trueï¼›&lt;/li>
&lt;li>apiserver æ¥åˆ°è¯·æ±‚åï¼Œå°†è¯·æ±‚è½¬å‘åˆ° kubeletï¼Œ node:10250/api/v1/exec/{ns}/{podid}/{container}ã€‚kubelet httpserver æ¥æ”¶åˆ°è¯·æ±‚åï¼š
&lt;ul>
&lt;li>é¦–å…ˆï¼Œå‘ dockershim å‘èµ· getExec è¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ªæµåœ°å€ url ï¼ˆexec/{token}ï¼‰ï¼›&lt;/li>
&lt;li>ç„¶åï¼Œkubelet è¯·æ±‚ exec/xxxx url åˆ° streaming serverï¼Œstreaming server æ¥æ”¶åˆ°è¯·æ±‚åï¼Œresponse upgrade å°†è¿æ¥å‡çº§æˆä¸º spdy æˆ– ws è¿æ¥ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>kubelet æ”¶åˆ° upgrade reponse åï¼Œå°†è¯¥ reponse ç›´æ¥è¿”å›ç»™ apiserverï¼Œåˆ°æ­¤ apiserver -&amp;gt; kubelet -&amp;gt; streaming server -&amp;gt; docker ä¹‹é—´æ•´ä¸ªé€šé“å»ºç«‹å®Œæˆï¼›&lt;/li>
&lt;li>åˆ°æ­¤ï¼Œç”¨æˆ·å¯ä»¥åœ¨ terminal ä¸­é”®å…¥å‘½ä»¤åœ¨å®¹å™¨ä¸­æ‰§è¡Œï¼›&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-uml.jpg"
width="2536"
height="1506"
srcset="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-uml_hu2f1e02e515e351c311ec896043222feb_281732_480x0_resize_q75_box.jpg 480w, https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/exec-uml_hu2f1e02e515e351c311ec896043222feb_281732_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="168"
data-flex-basis="404px"
>&lt;/p>
&lt;p>å…¶ä¸­ï¼Œ streaming server æ˜¯ kubelet å’Œ docker ä¹‹é—´çš„ä¸€ä¸ªæ¡¥æ¢ï¼Œä»–è´Ÿè´£å°†è¯·æ±‚è½¬å‘ç»™ dockerï¼ˆæˆ–è€…å…¶ä»– runtimeï¼‰ã€‚kubelet è®¿é—® streaming server çš„åœ°å€å°±æ˜¯ 127.0.0.1:{streaming sever port}ã€‚&lt;/p>
&lt;p>&lt;strong>è€Œæˆ‘ä»¬é‡åˆ°é—®é¢˜ä¸­ç«¯å£å†²çªï¼Œå°±æ˜¯ streaming server ç«¯å£å’Œ nodeport å†²çªã€‚kubelet æ‹¿åˆ° exec url åï¼Œå‘½ä¸­æœ¬åœ° iptables è§„åˆ™ï¼Œç„¶åè¯·æ±‚è¢«è½¬å‘åˆ°äº† nodeport å…³è”çš„å®¹å™¨ï¼Œè¿”å›ä¸Šè¿°é”™è¯¯ã€‚&lt;/strong>&lt;/p>
&lt;p>åœ¨æºç ç ”ç©¶è¿‡ç¨‹ä¸­ï¼Œå‚æ•° &amp;ndash;redirect-container-streaming å¼•èµ·äº†æˆ‘ä»¬çš„æ³¨æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">func (s *Server) getExec(request *restful.Request, response *restful.Response) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> .... çœç•¥è‹¥å¹²ä»£ç ....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> url, err := s.host.GetExec(podFullName, params.podUID, params.containerName, params.cmd, *streamOpts)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if err != nil {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> streaming.WriteError(err, response.ResponseWriter)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if s.redirectContainerStreaming {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> http.Redirect(response.ResponseWriter, request.Request, url.String(), http.StatusFound)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> return
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxyStream(response.ResponseWriter, request.Request, url)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥å‚æ•°å¼€å¯åä¼šå¹¶ä¸ä¼šè¿›è¡Œ proxyStreamã€‚è€Œæ˜¯ç›´æ¥å‘ apiserver å‘é€ 302 è·³è½¬ï¼Œæµç¨‹å˜ä¸ºå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-nostreamer.png"
width="1508"
height="1000"
srcset="https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-nostreamer_hu45498cf6e0b95b67adcec0e537e81e4b_116430_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/kubectl-exec-deepin/img/kubelet-nostreamer_hu45498cf6e0b95b67adcec0e537e81e4b_116430_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="150"
data-flex-basis="361px"
>&lt;/p>
&lt;p>è¯¥å‚æ•°è¯´æ˜ï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">--redirect-container-streaming Enables container streaming redirect. If false, kubelet will proxy container streaming data between apiserver and container runtime; if true, kubelet will return an http redirect to apiserver, and apiserver will access container runtime directly. The proxy approach is more secure, but introduces some overhead. The redirect approach is more performant, but less secure because the connection between apiserver and container runtime may not be authenticated.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦å¤–ï¼Œåœ¨ 1.18 ç‰ˆæœ¬ä¸­æˆ‘ä»¬å‘ç°è¯¥å‚æ•°å³å°†åºŸå¼ƒï¼Œç¤¾åŒºä¸­å·²ç»åœ¨ kep &lt;a class="link" href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1558-streaming-proxy-redirects#dependence-on-apiserver-redirects" target="_blank" rel="noopener"
>Cleaning up container streaming requests&lt;/a>ä¸­è¯¦ç»†è¯´æ˜äº†åç»­ä¸‹çº¿è®¡åˆ’ï¼ˆ1.18 è¿›è¡Œä¸‹çº¿æç¤ºã€1.20ç‰ˆæœ¬å‚æ•°å¤±æ•ˆã€1.22 å‚æ•°è¢«åˆ é™¤ï¼‰ã€‚åç»­ apiserver æ— æ³•ç›´æ¥å’Œ dockershim é€šä¿¡ã€‚&lt;/p>
&lt;h3 id="å¦‚ä½•é¿å…ç«¯å£å†²çª">å¦‚ä½•é¿å…ç«¯å£å†²çª&lt;/h3>
&lt;p>ç»è¿‡æºç é˜…è¯»ï¼Œæˆ‘ä»¬äº†è§£äº†æ‰§è¡Œ kube exec çš„æµç¨‹ï¼Œé€šè¿‡å…³é—­ streaming server å¯ä»¥é¿å… streaming server ç«¯å£å’Œ nodeport å†²çªã€‚ä½†æ˜¯è¯¥æ–¹æ¡ˆåªèƒ½åœ¨ 1.20 ç‰ˆæœ¬å‰çš„é›†ç¾¤ä¸­ä½¿ç”¨ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œè¿›ä¸€æ­¥æ€è€ƒï¼Œå¦‚æœå…¶ä»–è¿›ç¨‹ä½¿ç”¨äº†ä¸€ä¸ªéšæœºç«¯å£æ˜¯å¦ä¹Ÿä¼šå‡ºç°è¯¥é—®é¢˜å‘¢ï¼Ÿ&lt;/p>
&lt;p>è¿˜æ˜¯æœ‰ä¸€å®šå†²çªæ¦‚ç‡çš„ï¼Œåœ¨ &lt;a class="link" href="https://github.com/kubernetes/kubernetes/issues/85418" target="_blank" rel="noopener"
>#85418&lt;/a> issue ä¸­å°±æœ‰äººæå‡ºäº†è¯¥é—®é¢˜ï¼Œä»ç›¸å…³è®¨è®ºä¸­æ¨èè§£å†³æ–¹æ³•æ˜¯é€šè¿‡å®¿ä¸»æœºé¢„ç•™ç«¯å£ï¼ˆnet.ipv4.ip_local_port_rangeï¼‰è§£å†³ã€‚k8s apiserver é»˜è®¤çš„ nodeport ç«¯å£èŒƒå›´ä¸º 30000-32767 ï¼ˆé€šè¿‡ &amp;ndash;service-node-port-range å‚æ•°é…ç½®ï¼‰ï¼Œä¸€èˆ¬å®¿ä¸»æœº net.ipv4.ip_local_port_range é»˜è®¤èŒƒå›´ä¸º 32768-60999ã€‚è€Œæˆ‘ä»¬å‡ºç°å†²çªï¼Œå› ä¸ºä½¿ç”¨çš„æŸäº‘ k8s é›†ç¾¤ä¿®æ”¹äº† apiserver å‚æ•°ä¸º 30000-50000ï¼Œå¯¼è‡´å‡ºç°ç«¯å£å†²çªé—®é¢˜ã€‚&lt;/p>
&lt;p>å…¶å®ï¼Œkube-proxy ä¸ºäº†é¿å…ç«¯å£å†²çªçš„é—®é¢˜ï¼Œè¿è¡Œè¿‡ç¨‹ä¼šç›‘å¬æ‰€æœ‰çš„ nodeport ç«¯å£ã€‚ä½†æ˜¯ï¼Œè¿™å­˜åœ¨ä¸€ä¸ªé¸¡ç”Ÿè›‹çš„é—®é¢˜ã€‚å¦‚æœæŸä¸ª nodeport åˆ†é…å‰å·²ç»è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œæˆ–è€… kube-proxy é‡å¯ï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨ç«¯å£å†²çªçš„é—®é¢˜ã€‚åœ¨ &lt;a class="link" href="https://github.com/kubernetes/kubernetes/issues/100643" target="_blank" rel="noopener"
>#100643&lt;/a> issue ä¸­ä¹Ÿè¿›è¡Œäº†ç›¸å…³è®¨è®ºï¼Œå¸Œæœ›åç»­èƒ½æœ‰å®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>ç»¼ä¸Šï¼Œç›®å‰è§£å†³æ–¹æ¡ˆä¸‹é¢å‡ ç§ï¼š&lt;/p>
&lt;ol>
&lt;li>1.20 å‰ç‰ˆæœ¬å¯ä»¥é€šè¿‡ &amp;ndash;redirect-container-streaming å…³é—­ steaming serverï¼Œé¿å… kubelet å’Œ nodeport ç«¯å£å†²çªï¼›&lt;/li>
&lt;li>ä¿®æ”¹ç³»ç»Ÿå‚æ•°å’Œ apiserver ç«¯å£èŒƒå›´ï¼Œä¿è¯å’Œå®¿ä¸»æœºéšæœºç«¯å£èŒƒå›´ä¸é‡åˆï¼›&lt;/li>
&lt;li>å…¶ä»–æŠ€æœ¯ï¼Œä¾‹å¦‚ &lt;a class="link" href="https://github.com/kubernetes/kubernetes/issues/100643" target="_blank" rel="noopener"
>#100643&lt;/a> issue ä¸­æå‡ºçš„ ebpfã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>é€šè¿‡ä¸€ä¸ªç”Ÿäº§ &lt;code>kubectl exec&lt;/code>å¼‚å¸¸é—®é¢˜ï¼Œæˆ‘ä»¬äº†è§£äº†æ‰§è¡Œ exec å‘½ä»¤åï¼Œæ•´ä¸ªåº•å±‚è½¬å‘é€»è¾‘ï¼š&lt;/p>
&lt;ol>
&lt;li>apiserver æŸ¥è¯¢åˆ° pod æ‰€åœ¨ node ipï¼Œé€šè¿‡ nodeip:10250 ç«¯å£å‘ kubelet å‘èµ·è¯·æ±‚ï¼›&lt;/li>
&lt;li>kubelet æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘æœ¬åœ° runtime è·å– exec urlã€‚ç„¶åï¼Œ1.20 ä¹‹å‰ä¼šåŸºäºå‚æ•° &amp;ndash;redirect-container-streaming æœ‰ä¸¤ç§å¤„ç†æµç¨‹ï¼š
&lt;ol>
&lt;li>å¼€å¯å‚æ•°ï¼Œé€šè¿‡ 302 è·³è½¬æ–¹å¼ï¼Œå°† apiserver è¯·æ±‚é‡å®šå‘åˆ° exec urlï¼›&lt;/li>
&lt;li>å…³é—­å‚æ•°ï¼Œä¼šå…ˆç›´æ¥å’Œ runtime å»ºç«‹ exec é€šé“ï¼Œç„¶åå°† apiserver è¯·æ±‚å‡çº§ä¸º spdy æˆ– ws è¿æ¥ï¼›&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>åç»­ apisever å’Œ runtime é€šé“å»ºç«‹å®Œæˆï¼Œclient å°±å¯ä»¥åœ¨ terminal ä¸Šæ‰§è¡Œå‘½ä»¤äº†ã€‚&lt;/li>
&lt;/ol></description></item><item><title>äº‘ä¸Š pod ä¸‹çº¿å¼•èµ·çŸ­æ—¶æœåŠ¡ä¸å¯ç”¨</title><link>https://jasonrd.github.io/blog/p/service-cause-failure/</link><pubDate>Mon, 01 Nov 2021 00:00:00 +0000</pubDate><guid>https://jasonrd.github.io/blog/p/service-cause-failure/</guid><description>&lt;img src="https://jasonrd.github.io/blog/p/service-cause-failure/luca-bravo-alS7ewQ41M8-unsplash.jpg" alt="Featured image of post äº‘ä¸Š pod ä¸‹çº¿å¼•èµ·çŸ­æ—¶æœåŠ¡ä¸å¯ç”¨" />&lt;h2 id="1-èƒŒæ™¯">1. èƒŒæ™¯&lt;/h2>
&lt;p>è¿‘æ—¥ï¼Œæ¥è¿æ”¶åˆ°å¤šä¸ªäº‘ä¸Šç«™ç‚¹ä¸šåŠ¡å‡ºç° 502 é—®é¢˜åé¦ˆï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/502-error-1.png"
width="2980"
height="934"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/502-error-1_hucce7954739b6677286789b82e0e95e76_227221_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/502-error-1_hucce7954739b6677286789b82e0e95e76_227221_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="502-error-1"
class="gallery-image"
data-flex-grow="319"
data-flex-basis="765px"
>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/502-error-2.png"
width="1858"
height="1096"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/502-error-2_hub2cf4d7668d03fc5d2263866213f9d32_182813_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/502-error-2_hub2cf4d7668d03fc5d2263866213f9d32_182813_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="502-error-2"
class="gallery-image"
data-flex-grow="169"
data-flex-basis="406px"
>&lt;/p>
&lt;p>å’Œä¸šåŠ¡è´Ÿè´£äººæ²Ÿé€šåï¼Œåº”ç”¨ç¡®è®¤åŠ å…¥äº†ä¼˜é›…ä¸‹çº¿é€»è¾‘ã€‚&lt;/p>
&lt;h2 id="2-æ’æŸ¥è¿‡ç¨‹">2. æ’æŸ¥è¿‡ç¨‹&lt;/h2>
&lt;p>é¦–å…ˆï¼ŒæŸ¥çœ‹ç½‘å…³æ—¥å¿—ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-1.png"
width="2848"
height="364"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-1_hu34d8d5f831126b5a732d35045ac8e4b8_1033303_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-1_hu34d8d5f831126b5a732d35045ac8e4b8_1033303_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="782"
data-flex-basis="1877px"
>&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-2.png"
width="2812"
height="386"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-2_huc895b7a875e203a5b190847dbae686e8_916199_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-2_huc895b7a875e203a5b190847dbae686e8_916199_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="728"
data-flex-basis="1748px"
>&lt;/p>
&lt;p>ä¸¤æ¬¡æ—¥å¿—ï¼Œéƒ½æ˜¯è¯·æ±‚ LB IP å‡ºç° 503 é”™è¯¯ç åï¼Œç„¶åç½‘å…³å°† LB IP æ‘˜æ‰ã€‚&lt;/p>
&lt;p>åˆ†æä¸ºä»€ä¹ˆå‡ºç° 503 é”™è¯¯ç å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹å®¹å™¨ä¸‹çº¿é€»è¾‘ï¼šå®¹å™¨è¿›è¡Œä¸‹çº¿æ—¶ï¼Œä¼šè°ƒç”¨ prestop è„šæœ¬æ‰§è¡Œä¸‹çº¿å‰çš„æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨ prestop è„šæœ¬ä¸­ï¼Œé¦–å…ˆ sleep 15s ï¼ˆä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆï¼‰ï¼Œç„¶åè°ƒç”¨ http://127.0.0.1:${APP_PORT}/ok.htm?down=true æ¥å£é€šçŸ¥ java è¿›ç¨‹è¿›è¡Œä¼˜é›…ä¸‹çº¿ã€‚è¯¥æ¥å£è°ƒç”¨æˆåŠŸåï¼Œå†è¯·æ±‚åº”ç”¨ ok é¡µé¢ï¼Œè¿›å…¥ä¸‹é¢é€»è¾‘ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-prestop.png"
width="1055"
height="614"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-prestop_hu07c34cbbf302e9275effdebb12b729a9_402200_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-prestop_hu07c34cbbf302e9275effdebb12b729a9_402200_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="171"
data-flex-basis="412px"
>&lt;/p>
&lt;p>ä¹Ÿå°±æ˜¯è¿”å› halting æ•°æ®å’Œ503çŠ¶æ€ç ã€‚&lt;/p>
&lt;p>k8s ä¸­åœ¨å°† Pod è¿›è¡Œä¸‹çº¿ï¼ˆæ ‡è®°ä¸º Terminating çŠ¶æ€ï¼‰æ—¶ï¼Œk8s endpoint controller å°±å°†è¯¥ Pod ip ä» lb æˆ– service åç«¯åˆ—è¡¨ä¸­æ‘˜é™¤ã€‚æ—¢ç„¶ lb/svc å·²ç»å°†åœ¨è¯¥ pod IP æ‘˜é™¤ï¼Œä¸ºä»€ä¹ˆä»ç„¶è¯·æ±‚åˆ° halting Pod å‘¢ï¼Ÿ&lt;/p>
&lt;p>åœ¨è¿›å…¥åº”ç”¨å®¹å™¨ä¸­è¿›è¡ŒæŠ“åŒ…ï¼Œå¹¶å’Œåº”ç”¨è´Ÿè´£äººç¡®è®¤åï¼Œç½‘å…³ -&amp;gt; lb -&amp;gt; pod æ˜¯ä½¿ç”¨ http é•¿è¿æ¥æ–¹å¼ã€‚&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-netflow.png"
width="1762"
height="788"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-netflow_hu2cc8ce7b54497507118a4db625573fcb_324383_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-netflow_hu2cc8ce7b54497507118a4db625573fcb_324383_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="223"
data-flex-basis="536px"
>&lt;/p>
&lt;p>åœ¨ Pod å¤„äº terminating çŠ¶æ€æ—¶ï¼Œé€šè¿‡ svc è¯·æ±‚æ—¶æ–°å»ºç«‹çš„è¿æ¥å°†ä¸ä¼šè½¬å‘åˆ°è¯¥ podï¼Œä½†æ˜¯å·²ç»å»ºç«‹çš„è¿æ¥åœ¨ Pod å®Œå…¨åˆ é™¤å‰ä»å¯ç»§ç»­é€šä¿¡ã€‚æ‰€ä»¥ï¼Œè™½ç„¶ service å°† Pod IP æ‘˜é™¤ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯å®¹å™¨çš„ä¼˜é›…ä¸‹çº¿ï¼Œå·²ç»å»ºç«‹çš„è¿æ¥ä»ç„¶å¯ä»¥ç»§ç»­å¤„ç†ä¸šåŠ¡ï¼Œç›´åˆ°å®¹å™¨å½»åº•è¢«åˆ é™¤ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç”¨ python ç®€å•å†™äº†ä¸€ä¸ªä½¿ç”¨ http é•¿è¿æ¥å®¢æˆ·ç«¯ï¼Œè¿›è¡Œä¸€ä¸‹æµ‹è¯•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">client&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">requests&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">session&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;application/json&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;Connection&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;keep-alive&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://xx.xx.16.137:8088/ok.htm&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">headers&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># xx.xx.16.137 ä¸ºåº”ç”¨ lb IP &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status_code&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>python client è¯·æ±‚åº”ç”¨å®¹å™¨ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-3.png"
width="1770"
height="592"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-3_hu29f5ad8b11850c039f2c666148aa389d_770926_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-3_hu29f5ad8b11850c039f2c666148aa389d_770926_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="298"
data-flex-basis="717px"
>&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-4.png"
width="1772"
height="570"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-4_hu7194f66dd6011e9b2627f0ff6ec5b69b_848304_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-4_hu7194f66dd6011e9b2627f0ff6ec5b69b_848304_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="310"
data-flex-basis="746px"
>&lt;/p>
&lt;p>ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ 15:30:06 å°† pod è¿›è¡Œ kill åï¼Œé€šè¿‡é•¿è¿æ¥ä»ç„¶å¯ä»¥å°†è¯·æ±‚è½¬å‘åˆ°å¤„äº terminating çš„åº”ç”¨å®¹å™¨ã€‚ç›´åˆ° 15s åè°ƒç”¨ä¸‹çº¿æ¥å£ï¼Œè¯·æ±‚è¿”å› 503ã€‚è¯·æ±‚å¤„äº halting çŠ¶æ€çš„ podï¼Œserver ç«¯ä¼šä¸»åŠ¨ close è¯·æ±‚ï¼š&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-5.png"
width="1298"
height="580"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-5_hub914d7d26274e94e5b363dd62be85e28_370469_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/troubleshoot-5_hub914d7d26274e94e5b363dd62be85e28_370469_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="223"
data-flex-basis="537px"
>&lt;/p>
&lt;p>å¦å¤–ï¼Œæˆ‘ä»¬æµ‹è¯•åº”ç”¨åªæœ‰å•ä¸ªå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯å®ä¾‹è¢«åˆ é™¤åï¼Œlb åç«¯å®ä¾‹ä¸º 0ï¼Œè¯·æ±‚ lb çš„æ–°è¿æ¥æ— æ³•å»ºç«‹ã€‚æ‰€ä»¥ï¼Œæµ‹è¯•è„šæœ¬ä¼šå‡ºç° connect refused æŠ¥é”™ã€‚&lt;/p>
&lt;h2 id="3-è§£å†³æ–¹æ³•">3. è§£å†³æ–¹æ³•&lt;/h2>
&lt;p>ç»¼ä¸Šå¯çŸ¥ï¼Œé—®é¢˜åŸå› æ˜¯ kill pod åä»ç„¶ä¼šæœ‰æµé‡è¿›å…¥åˆ° terminating çŠ¶æ€çš„ podï¼Œç„¶å 15s å prestop è„šæœ¬é€šçŸ¥è¿›ç¨‹è¿›è¡Œä¸‹çº¿é€»è¾‘ï¼ˆä¹Ÿå°±æ˜¯ ok é¡µé¢è¿”å› halting å’Œ 503 çŠ¶æ€ç ï¼‰ï¼Œå½“ç½‘å…³ç»§ç»­è¯·æ±‚åˆ°è¯¥ pod å°±ä¼šè®¤ä¸º lb å‡ºç°å¼‚å¸¸ï¼Œå°†å”¯ä¸€çš„ lb æ ‡è®°ä¸ºä¸å¥åº·ï¼Œä»è€Œå‡ºç° 502 å¼‚å¸¸ã€‚&lt;/p>
&lt;p>å…¶ä»–ç«™ç‚¹æœªå‡ºç°è¯¥é—®é¢˜åŸå› æ˜¯ï¼šç½‘å…³ç›´æ¥è½¬å‘åˆ° pod ipï¼Œæ‘˜æ‰çš„æ˜¯å‡ºç°å¼‚å¸¸çš„ pod ip ã€‚è€Œæœ‰é—®é¢˜çš„ç«™ç‚¹å¯¹æ¥çš„åªæ˜¯ä¸€ä¸ªå…¬æœ‰äº‘ LB ipã€‚&lt;/p>
&lt;p>&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-1.png"
width="888"
height="768"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-1_huf2a69d255e32c6a8b07aa332757aa208_267530_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-1_huf2a69d255e32c6a8b07aa332757aa208_267530_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="115"
data-flex-basis="277px"
>&lt;/p>
&lt;p>å…·ä½“ä¼˜åŒ–é€»è¾‘å¦‚ä¸‹(å¦‚ä¸Šå›¾ï¼Œé’ˆå¯¹å•ä¸ªpod):&lt;/p>
&lt;ol>
&lt;li>åº”ç”¨å¢åŠ  connection filterï¼Œåœ¨åº”ç”¨è¿›å…¥ä¼˜é›…ä¸‹çº¿ï¼ˆè¢«è°ƒç”¨ http://127.0.0.1:${APP_PORT}/ok.htm?down=trueï¼‰åï¼Œæ‰€æœ‰è¯·æ±‚çš„ http å“åº”å¤´ä¸­å¢åŠ  connection:closeï¼ˆä¹Ÿå°±æ˜¯ä½¿ç”¨çŸ­è¿æ¥ï¼‰ï¼›
&lt;ol>
&lt;li>å› ä¸º pod å¤„äº terminating æ—¶ï¼Œæ–°è¿æ¥ä¸ä¼šè¿›å…¥è¯¥ podï¼›&lt;/li>
&lt;li>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š
&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-2.png"
width="1738"
height="1016"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-2_hu8faba495cdcf5af6c2ac4f3e2d23be71_653499_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-2_hu8faba495cdcf5af6c2ac4f3e2d23be71_653499_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="171"
data-flex-basis="410px"
>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>å¥åº·æ£€æŸ¥æ¥å£ï¼Œä¿®æ”¹ä¸ºå»æ‰ 503 å¼‚å¸¸ï¼Œé¿å…ç½‘å…³æ£€æµ‹åˆ° 503 å¼‚å¸¸æ—¶ï¼Œç›´æ¥æ‘˜æ‰ lb ipã€‚
&lt;ol>
&lt;li>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š
&lt;img src="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-3.png"
width="1482"
height="696"
srcset="https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-3_hu095a7d17af90f9d81e0a9c0715e7a55d_439334_480x0_resize_box_3.png 480w, https://jasonrd.github.io/blog/blog/p/service-cause-failure/img/solution-3_hu095a7d17af90f9d81e0a9c0715e7a55d_439334_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="212"
data-flex-basis="511px"
>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol></description></item><item><title>Links</title><link>https://jasonrd.github.io/blog/links/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://jasonrd.github.io/blog/links/</guid><description>&lt;p>To use this feature, add &lt;code>links&lt;/code> section to frontmatter.&lt;/p>
&lt;p>This page&amp;rsquo;s frontmatter:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">links&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">title&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">GitHub&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">GitHub is the world&amp;#39;s largest software development platform.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">website&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">title&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TypeScript&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TypeScript is a typed superset of JavaScript that compiles to plain JavaScript.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">website&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://www.typescriptlang.org&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ts-logo-128.jpg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>image&lt;/code> field accepts both local and external images.&lt;/p></description></item><item><title>Search</title><link>https://jasonrd.github.io/blog/search/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://jasonrd.github.io/blog/search/</guid><description/></item><item><title>å…³äº</title><link>https://jasonrd.github.io/blog/%E5%85%B3%E4%BA%8E/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://jasonrd.github.io/blog/%E5%85%B3%E4%BA%8E/</guid><description>&lt;p>æ¬¢è¿æ¥åˆ°æˆ‘çš„å°å±‹ğŸ›–&lt;/p></description></item></channel></rss>