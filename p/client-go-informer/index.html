<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æ—¥å¸¸ operator å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ informerï¼Œä½†æ˜¯å¯¹å†…éƒ¨å®ç°å¹¶ä¸äº†è§£ï¼Œæœ¬æ–‡å¯¹informer å®ç°è¿›è¡Œæ·±åº¦æ¢ç©¶ï¼Œä¾¿äºæ—¥åå¼€å‘ä¸­é—®é¢˜åˆ†æ"><title>informer å†…éƒ¨å®ç°æ¢ç©¶</title><link rel=canonical href=https://jasonrd.github.io/blog/p/client-go-informer/><link rel=stylesheet href=/blog/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="informer å†…éƒ¨å®ç°æ¢ç©¶"><meta property="og:description" content="æ—¥å¸¸ operator å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ informerï¼Œä½†æ˜¯å¯¹å†…éƒ¨å®ç°å¹¶ä¸äº†è§£ï¼Œæœ¬æ–‡å¯¹informer å®ç°è¿›è¡Œæ·±åº¦æ¢ç©¶ï¼Œä¾¿äºæ—¥åå¼€å‘ä¸­é—®é¢˜åˆ†æ"><meta property="og:url" content="https://jasonrd.github.io/blog/p/client-go-informer/"><meta property="og:site_name" content="jason's åšå®¢"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2021-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-15T00:00:00+00:00"><meta property="og:image" content="https://jasonrd.github.io/blog/p/client-go-informer/informer-arch.png"><meta name=twitter:site content="@jasonxie666"><meta name=twitter:creator content="@jasonxie666"><meta name=twitter:title content="informer å†…éƒ¨å®ç°æ¢ç©¶"><meta name=twitter:description content="æ—¥å¸¸ operator å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ informerï¼Œä½†æ˜¯å¯¹å†…éƒ¨å®ç°å¹¶ä¸äº†è§£ï¼Œæœ¬æ–‡å¯¹informer å®ç°è¿›è¡Œæ·±åº¦æ¢ç©¶ï¼Œä¾¿äºæ—¥åå¼€å‘ä¸­é—®é¢˜åˆ†æ"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jasonrd.github.io/blog/p/client-go-informer/informer-arch.png"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/avatar_hu92a1f0f4dac05816138a9efb01424f59_787601_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>jason's åšå®¢</a></h1><h2 class=site-description>Welcom</h2></div></header><ol class=social-menu><li><a href=https://github.com/JasonRD target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/jasonxie666 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>ä¸»é¡µ</span></a></li><li><a href=/blog/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>å…³äº</span></a></li><li><a href=/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/blog/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://jasonrd.github.io/blog/en/>English</option><option value=https://jasonrd.github.io/blog/ selected>ä¸­æ–‡</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ä½¿ç”¨å¥—è·¯>ä½¿ç”¨å¥—è·¯</a></li><li><a href=#æ‰§è¡Œé€»è¾‘>æ‰§è¡Œé€»è¾‘</a><ol><li><a href=#eventhandler-å›è°ƒå‡½æ•°æ³¨å†Œå’Œæ‰§è¡Œè¿‡ç¨‹>eventhandler å›è°ƒå‡½æ•°æ³¨å†Œå’Œæ‰§è¡Œè¿‡ç¨‹</a></li><li><a href=#æ›´æ–°-indexer-ç¼“å­˜å’Œ-deltas-evnet-äº‹ä»¶å¤„ç†>æ›´æ–° indexer ç¼“å­˜å’Œ deltas evnet äº‹ä»¶å¤„ç†</a></li><li><a href=#list-watch-èµ„æº-event-äº‹ä»¶å’Œ-deltas-event-ç”Ÿäº§>list watch èµ„æº Event äº‹ä»¶å’Œ deltas event ç”Ÿäº§</a></li></ol></li><li><a href=#ä¸»è¦å¯¹è±¡æ•°æ®ç»“æ„>ä¸»è¦å¯¹è±¡æ•°æ®ç»“æ„</a><ol><li><a href=#controller>Controller</a></li><li><a href=#reflector>reflector</a></li><li><a href=#sharedprocessor>sharedProcessor</a></li><li><a href=#processlistner>processListner</a></li></ol></li><li><a href=#ç–‘é—®>ç–‘é—®</a><ol><li><a href=#ä¸ºä»€ä¹ˆéœ€è¦-waitforcachesync>ä¸ºä»€ä¹ˆéœ€è¦ waitForCacheSync</a></li><li><a href=#ä¸ºä»€ä¹ˆä½¿ç”¨-workqueue->ä¸ºä»€ä¹ˆä½¿ç”¨ workqueue ï¼Ÿ</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/p/client-go-informer/><img src=/blog/p/client-go-informer/informer-arch_hu99f14accc96104069d2695ab8dd85549_718091_800x0_resize_box_3.png srcset="/blog/p/client-go-informer/informer-arch_hu99f14accc96104069d2695ab8dd85549_718091_800x0_resize_box_3.png 800w, /blog/p/client-go-informer/informer-arch_hu99f14accc96104069d2695ab8dd85549_718091_1600x0_resize_box_3.png 1600w" width=800 height=595 loading=lazy alt="Featured image of post informer å†…éƒ¨å®ç°æ¢ç©¶"></a></div><div class=article-details><header class=article-category><a href=/blog/categories/kubernetes/ style=background-color:#2a9d8f;color:#fff>kubernetes</a>
<a href=/blog/categories/client-go/>client-go</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/client-go-informer/>informer å†…éƒ¨å®ç°æ¢ç©¶</a></h2><h3 class=article-subtitle>æ—¥å¸¸ operator å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ informerï¼Œä½†æ˜¯å¯¹å†…éƒ¨å®ç°å¹¶ä¸äº†è§£ï¼Œæœ¬æ–‡å¯¹informer å®ç°è¿›è¡Œæ·±åº¦æ¢ç©¶ï¼Œä¾¿äºæ—¥åå¼€å‘ä¸­é—®é¢˜åˆ†æ</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 15, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 11 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=ä½¿ç”¨å¥—è·¯>ä½¿ç”¨å¥—è·¯</h2><p>informer ä½¿ç”¨å¥—è·¯ï¼ˆå…¶ä¸­ç•¥å»ä¸€äº›ç»†èŠ‚ï¼Œå…·ä½“å‚è€ƒ<a class=link href=https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go target=_blank rel=noopener>informers demo</a>ï¼‰:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 1. åˆ›å»º k8s client å¯¹è±¡ï¼š
</span></span><span class=line><span class=cl>cfg, err = clientcmd.BuildConfigFromFlags(masterURL, kubeconfig)
</span></span><span class=line><span class=cl>kube_client, err = kubernetes.NewForConfig(cfg)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 2. åˆ›å»ºèµ„æº informerï¼Œä»¥ POD ä¸ºä¾‹ï¼š
</span></span><span class=line><span class=cl>factory = kubeinformers.NewSharedInformerFactory(client, 0)
</span></span><span class=line><span class=cl>pod_informer = ctrl.factory.Core().V1().Pods()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 3. æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨æ¥å¤„ç† Addã€Updateã€Delete äº‹ä»¶ï¼š
</span></span><span class=line><span class=cl>pod_informer.Informer().AddEventHandler(handler)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>handler å®ç°äº† OnAddã€OnUpdateã€OnDelete ä¸‰ä¸ªæ¥å£çš„:
</span></span><span class=line><span class=cl>type handler struct  {
</span></span><span class=line><span class=cl>    queue: workqueue.NewRateLimitingQueue(workqueue.DefaultControllerRateLimiter())
</span></span><span class=line><span class=cl>    OnAdd: func (obj interface{}) {
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>        queue.Add(cache.MetaNamespaceKeyFunc(obj))
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>    },
</span></span><span class=line><span class=cl>    OnUpdate: func(obj, obj interface{}) {
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>        queue.Add(cache.MetaNamespaceKeyFunc(obj))
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>    },
</span></span><span class=line><span class=cl>    OnDelete: func(obj interface{}) {
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>        cache.DeletionHandlingMetaNamespaceKeyFunc(obj)
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>    },
</span></span><span class=line><span class=cl>    Task: func() {
</span></span><span class=line><span class=cl>        key, quit := c.queue.Get()
</span></span><span class=line><span class=cl>        defer c.queue.Done(key)
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 4. å¯åŠ¨ informer 
</span></span><span class=line><span class=cl>factory.Start(stop)
</span></span></code></pre></td></tr></table></div></div><p>informers åŒ…ä¸­æä¾›äº†å·¥å‚ç±»ï¼Œé€šè¿‡è°ƒç”¨æ¥å£<code>factory.Core().V1().Pods()</code>åˆ›å»º k8s pod informer å¯¹è±¡ï¼Œå…¶ä»– k8s å†…ç½®èµ„æºç±»åŒã€‚informer å°è£…éƒ½åœ¨ <code>k8s.io/client-go/pkg/informers</code> åŒ…ä¸­ã€‚</p><h2 id=æ‰§è¡Œé€»è¾‘>æ‰§è¡Œé€»è¾‘</h2><p><img src=/blog/p/client-go-informer/img/informer-arch.png width=1438 height=1070 srcset="/blog/p/client-go-informer/img/informer-arch_hu99f14accc96104069d2695ab8dd85549_718091_480x0_resize_box_3.png 480w, /blog/p/client-go-informer/img/informer-arch_hu99f14accc96104069d2695ab8dd85549_718091_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=134 data-flex-basis=322px></p><h3 id=eventhandler-å›è°ƒå‡½æ•°æ³¨å†Œå’Œæ‰§è¡Œè¿‡ç¨‹>eventhandler å›è°ƒå‡½æ•°æ³¨å†Œå’Œæ‰§è¡Œè¿‡ç¨‹</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type sharedIndexInformer struct {
</span></span><span class=line><span class=cl>    // å¸¦ç´¢å¼•èµ„æº cache
</span></span><span class=line><span class=cl>    indexer    Indexer
</span></span><span class=line><span class=cl>    // èµ„æºæ§åˆ¶å™¨ï¼Œè´Ÿè´£:
</span></span><span class=line><span class=cl>    // 1. å¯åŠ¨ reflector list&amp;watch;
</span></span><span class=line><span class=cl>    // 2. Addã€Updateã€Delete äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šçŸ¥ processor æ‰§è¡Œè®¢é˜…ä»»åŠ¡ï¼›
</span></span><span class=line><span class=cl>    // 3. ä»¥åŠcacheç¼“å­˜æ›´æ–°ï¼Œå¤„ç†é€»è¾‘åœ¨ sharedIndexInformer.HandleDeltasï¼›
</span></span><span class=line><span class=cl>    // controller å¯¹è±¡åœ¨æ‰§è¡Œ sharedIndexInformer.Run å‡½æ•°æ—¶åˆå§‹åŒ–
</span></span><span class=line><span class=cl>    controller Controller
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // è´Ÿè´£äº‹ä»¶è§¦å‘æ—¶ï¼Œæ‰§è¡Œè®¢é˜…è€…çš„ OnAddã€OnUpdateã€OnDelete å›è°ƒé€»è¾‘ 
</span></span><span class=line><span class=cl>    processor             *sharedProcessor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // list&amp;watch èµ„æºå˜åŒ–ï¼Œwatch é€šè¿‡ chunk å®ç°èµ„æºå‘ç”Ÿå˜æ›´æ—¶è¿›è¡Œæ¨é€
</span></span><span class=line><span class=cl>    listerWatcher ListerWatcher
</span></span><span class=line><span class=cl>    // å…³æ³¨çš„èµ„æºç±»å‹
</span></span><span class=line><span class=cl>    objectType    runtime.Object
</span></span><span class=line><span class=cl>    .......
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>sharedIndexInformer å¯¹è±¡è¢«åˆ›å»ºåï¼Œæ‰§è¡Œ <code>Run</code> å‡½æ•°å¯åŠ¨äº‹ä»¶ç›‘å¬ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (s *sharedIndexInformer) Run(stopCh &lt;-chan struct{}) {
</span></span><span class=line><span class=cl>    defer utilruntime.HandleCrash()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—
</span></span><span class=line><span class=cl>    fifo := NewDeltaFIFO(MetaNamespaceKeyFunc, s.indexer)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    cfg := &amp;Config{
</span></span><span class=line><span class=cl>        Queue:            fifo,
</span></span><span class=line><span class=cl>        ListerWatcher:    s.listerWatcher,
</span></span><span class=line><span class=cl>        ObjectType:       s.objectType,
</span></span><span class=line><span class=cl>        FullResyncPeriod: s.resyncCheckPeriod,
</span></span><span class=line><span class=cl>        RetryOnError:     false,
</span></span><span class=line><span class=cl>        ShouldResync:     s.processor.shouldResync,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        // æ¶ˆè´¹ fifo é˜Ÿåˆ—ï¼Œåœ¨ controller.processLoop å‡½æ•°ä¸­æ‰§è¡Œ
</span></span><span class=line><span class=cl>        Process: s.HandleDeltas,
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // å‡å°é”ç²’åº¦
</span></span><span class=line><span class=cl>    func() {
</span></span><span class=line><span class=cl>        s.startedLock.Lock()
</span></span><span class=line><span class=cl>        defer s.startedLock.Unlock()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        // åˆå§‹åŒ– controller
</span></span><span class=line><span class=cl>        s.controller = New(cfg)
</span></span><span class=line><span class=cl>        s.controller.(*controller).clock = s.clock
</span></span><span class=line><span class=cl>        s.started = true
</span></span><span class=line><span class=cl>    }()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    // é¦–å…ˆå¯åŠ¨äº‹ä»¶å¤„ç†å™¨ï¼Œç›‘å¬äº‹ä»¶é€šçŸ¥
</span></span><span class=line><span class=cl>    wg.StartWithChannel(processorStopCh, s.processor.run)
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    // å¯åŠ¨ controller
</span></span><span class=line><span class=cl>    s.controller.Run(stopCh)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>åœ¨äº†è§£ <code>processor.run</code> å‡½æ•°é€»è¾‘å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹æˆ‘ä»¬å…³æ³¨çš„äº‹ä»¶å›è°ƒå‡½æ•°æ˜¯å¦‚ä½•æ³¨å†Œçš„ã€‚åœ¨è°ƒç”¨ sharedIndexInformer.AddEventHandler(handler) å®é™…ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ª processListner äº‹ä»¶ç›‘å¬å™¨ï¼Œç„¶åæ³¨å†Œåˆ° processor ä¸­è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (s *sharedIndexInformer) AddEventHandlerWithResyncPeriod(handler ResourceEventHandler, resyncPeriod time.Duration) {
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    listener := newProcessListener(handler, resyncPeriod, determineResyncPeriod(resyncPeriod, s.resyncCheckPeriod), s.clock.Now(), initialBufferSize)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    // æ³¨å†Œåˆ° processor listeners æ•°ç»„ä¸­
</span></span><span class=line><span class=cl>    s.processor.addListener(listener)
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>æ˜ç™½äº†å›è°ƒå‡½æ•°å¦‚ä½•æ³¨å†Œçš„ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ <code>processor.run</code> å‡½æ•°ï¼Œäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå›è°ƒå‡½æ•°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (p *sharedProcessor) run(stopCh &lt;-chan struct{}) {
</span></span><span class=line><span class=cl>    // ç»†ç²’åº¦é”
</span></span><span class=line><span class=cl>    func() {
</span></span><span class=line><span class=cl>        p.listenersLock.RLock()
</span></span><span class=line><span class=cl>        defer p.listenersLock.RUnlock()
</span></span><span class=line><span class=cl>        // å¼‚æ­¥å¯åŠ¨æ‰€æœ‰ç›‘å¬å™¨ï¼Œå®Œæˆäº‹ä»¶çš„æ¶ˆè´¹
</span></span><span class=line><span class=cl>        for _, listener := range p.listeners {
</span></span><span class=line><span class=cl>            p.wg.Start(listener.run)
</span></span><span class=line><span class=cl>            p.wg.Start(listener.pop)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        p.listenersStarted = true
</span></span><span class=line><span class=cl>    }()
</span></span><span class=line><span class=cl>    &lt;-stopCh
</span></span><span class=line><span class=cl>    p.listenersLock.RLock()
</span></span><span class=line><span class=cl>    defer p.listenersLock.RUnlock()
</span></span><span class=line><span class=cl>    for _, listener := range p.listeners {
</span></span><span class=line><span class=cl>        close(listener.addCh) // Tell .pop() to stop. .pop() will tell .run() to stop
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    p.wg.Wait() // Wait for all .pop() and .run() to stop
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢å‡½æ•°ä¸­ <code>listener.run</code> å’Œ <code>listener.pop</code> å‡½æ•°ï¼Œä¸¤ä¸ªå‡½æ•°é…åˆå®Œæˆæ”¶åˆ°äº‹ä»¶ï¼Œå¹¶æ‰§è¡Œå›è°ƒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// æ¶ˆè´¹ processor å¹¿æ’­çš„äº‹ä»¶ï¼Œå¹¶é€šè¿‡ channel å†…éƒ¨è½¬å‘
</span></span><span class=line><span class=cl>// è¿™ä¸ªå‡½æ•°æŒºæœ‰æ„æ€ï¼Œé€šè¿‡ä¸¤ä¸ª channel å®Œæˆäº‹ä»¶çš„ç¼“å­˜å’Œé€šçŸ¥ã€‚é€šè¿‡ addCh æ— ç¼“å­˜ channel é€šçŸ¥ã€‚
</span></span><span class=line><span class=cl>// é¦–æ¬¡å‡½æ•°å¯åŠ¨æˆ–é€šçŸ¥äº‹ä»¶æ¶ˆè´¹å®Œæˆï¼ŒnextCh ä¸º nilï¼Œç¬¬ä¸€ä¸ª case ä¼šä¸€ç›´é˜»å¡åˆ°æ–°äº‹ä»¶è¿‡æ¥
</span></span><span class=line><span class=cl>// å¦‚æœäº‹ä»¶é€šçŸ¥é€Ÿåº¦å¤§äºæ¶ˆè´¹é€Ÿåº¦ï¼Œä¼šå°†äº‹ä»¶ç¼“å­˜åœ¨ pendingNotifications å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œç„¶åå¼‚æ­¥æ¶ˆè´¹
</span></span><span class=line><span class=cl>func (p *processorListener) pop() {
</span></span><span class=line><span class=cl>    defer utilruntime.HandleCrash()
</span></span><span class=line><span class=cl>    defer close(p.nextCh) // Tell .run() to stop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    var nextCh chan&lt;- interface{}
</span></span><span class=line><span class=cl>    var notification interface{}
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>        select {
</span></span><span class=line><span class=cl>        // 1 listener å†…éƒ¨å¹¿æ’­äº‹ä»¶
</span></span><span class=line><span class=cl>        case nextCh &lt;- notification:
</span></span><span class=line><span class=cl>            // Notification dispatched
</span></span><span class=line><span class=cl>            var ok bool
</span></span><span class=line><span class=cl>            // 2 æ¶ˆè´¹ç¼“å­˜äº‹ä»¶
</span></span><span class=line><span class=cl>            notification, ok = p.pendingNotifications.ReadOne()
</span></span><span class=line><span class=cl>            if !ok { // Nothing to pop
</span></span><span class=line><span class=cl>                nextCh = nil // Disable this select case
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        // 3 æ¥æ”¶ processor é€šçŸ¥äº‹ä»¶
</span></span><span class=line><span class=cl>        case notificationToAdd, ok := &lt;-p.addCh:
</span></span><span class=line><span class=cl>            if !ok {
</span></span><span class=line><span class=cl>                return
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            // 4 notification ä¸º nil è¯´æ˜æ²¡æœ‰æœªæ¶ˆè´¹çš„äº‹ä»¶ï¼Œä¹‹é—´å†…éƒ¨å¹¿æ’­
</span></span><span class=line><span class=cl>            if notification == nil { 
</span></span><span class=line><span class=cl>                notification = notificationToAdd
</span></span><span class=line><span class=cl>                nextCh = p.nextCh
</span></span><span class=line><span class=cl>            // 5 æ¥ä¸åŠæ¶ˆè´¹ï¼Œå…ˆæš‚å­˜
</span></span><span class=line><span class=cl>            } else { 
</span></span><span class=line><span class=cl>                p.pendingNotifications.WriteOne(notificationToAdd)
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>ä¸‹é¢ä½¿ç”¨äº† wait.Until å‡½æ•°ï¼Œåœ¨é—­åŒ…æ‰§è¡Œå®Œæˆåï¼Œé—´éš”1åˆ†é’Ÿå†æ¬¡æ‰§è¡Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (p *processorListener) run() {
</span></span><span class=line><span class=cl>    stopCh := make(chan struct{})
</span></span><span class=line><span class=cl>    wait.Until(func() {
</span></span><span class=line><span class=cl>        // this gives us a few quick retries before a long pause and then a few more quick retries
</span></span><span class=line><span class=cl>        err := wait.ExponentialBackoff(retry.DefaultRetry, func() (bool, error) {
</span></span><span class=line><span class=cl>            // æˆ‘ä»¬å…³æ³¨å›è°ƒçœŸæ­£çš„æ‰§è¡Œåœ°æ–¹
</span></span><span class=line><span class=cl>            // p.nextCh æ— ç¼“å†² channel ç”±ä¸Šé¢ pop å‡½æ•°ä¼ å…¥äº‹ä»¶
</span></span><span class=line><span class=cl>            for next := range p.nextCh {
</span></span><span class=line><span class=cl>                switch notification := next.(type) {
</span></span><span class=line><span class=cl>                case updateNotification:
</span></span><span class=line><span class=cl>                    p.handler.OnUpdate(notification.oldObj, notification.newObj)
</span></span><span class=line><span class=cl>                case addNotification:
</span></span><span class=line><span class=cl>                    p.handler.OnAdd(notification.newObj)
</span></span><span class=line><span class=cl>                case deleteNotification:
</span></span><span class=line><span class=cl>                    p.handler.OnDelete(notification.oldObj)
</span></span><span class=line><span class=cl>                default:
</span></span><span class=line><span class=cl>                    utilruntime.HandleError(fmt.Errorf(&#34;unrecognized notification: %#v&#34;, next))
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            // the only way to get here is if the p.nextCh is empty and closed
</span></span><span class=line><span class=cl>            return true, nil
</span></span><span class=line><span class=cl>        })
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        // the only way to get here is if the p.nextCh is empty and closed
</span></span><span class=line><span class=cl>        if err == nil {
</span></span><span class=line><span class=cl>            close(stopCh)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }, 1*time.Minute, stopCh)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=æ›´æ–°-indexer-ç¼“å­˜å’Œ-deltas-evnet-äº‹ä»¶å¤„ç†>æ›´æ–° indexer ç¼“å­˜å’Œ deltas evnet äº‹ä»¶å¤„ç†</h3><p>HandleDeltas å‡½æ•°å®ç°äº† fifo é˜Ÿåˆ—æ¶ˆè´¹é€»è¾‘ï¼Œåˆ†åˆ«å¯¹å„äº‹ä»¶ç±»å‹åˆ†åˆ«æ“ä½œ indexer ç´¢å¼•ç¼“å­˜å’Œé€šçŸ¥ processor å‘è®¢é˜…è€…åˆ†å‘äº‹ä»¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// å¤„ç† fifo å¼¹å‡ºäº‹ä»¶
</span></span><span class=line><span class=cl>func (s *sharedIndexInformer) HandleDeltas(obj interface{}) error {
</span></span><span class=line><span class=cl>    .......
</span></span><span class=line><span class=cl>    for _, d := range obj.(Deltas) {
</span></span><span class=line><span class=cl>        switch d.Type {
</span></span><span class=line><span class=cl>        case Sync, Added, Updated:
</span></span><span class=line><span class=cl>            ......
</span></span><span class=line><span class=cl>            if old, exists, err := s.indexer.Get(d.Object); err == nil &amp;&amp; exists {
</span></span><span class=line><span class=cl>                if err := s.indexer.Update(d.Object); err != nil {
</span></span><span class=line><span class=cl>                    return err
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>                // é€šçŸ¥ processor å‘è®¢é˜…è€…å¹¿æ’­äº‹ä»¶
</span></span><span class=line><span class=cl>                s.processor.distribute(updateNotification{oldObj: old, newObj: d.Object}, isSync)
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>                if err := s.indexer.Add(d.Object); err != nil {
</span></span><span class=line><span class=cl>                    return err
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>                s.processor.distribute(addNotification{newObj: d.Object}, isSync)
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        case Deleted:
</span></span><span class=line><span class=cl>            if err := s.indexer.Delete(d.Object); err != nil {
</span></span><span class=line><span class=cl>                return err
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            s.processor.distribute(deleteNotification{oldObj: d.Object}, false)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return nil
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>HandleDeltas å‡½æ•°çš„æ‰§è¡Œæ—¶åœ¨ controller å¯åŠ¨æ—¶ï¼Œæ¯ç§’é’Ÿè°ƒç”¨ <code>controller.processLoop</code> æ¶ˆè´¹ DeltaFIFO ä¸­äº‹ä»¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (c *controller) Run(stopCh &lt;-chan struct{}) {
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    r := NewReflector(
</span></span><span class=line><span class=cl>        c.config.ListerWatcher,
</span></span><span class=line><span class=cl>        c.config.ObjectType,
</span></span><span class=line><span class=cl>        c.config.Queue,
</span></span><span class=line><span class=cl>        c.config.FullResyncPeriod,
</span></span><span class=line><span class=cl>    )
</span></span><span class=line><span class=cl>    ........
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    wg.StartWithChannel(stopCh, r.Run)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    wait.Until(c.processLoop, time.Second, stopCh)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>æ¶ˆè´¹ listwatch å†™å…¥ DeltaFIFO çš„äº‹ä»¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (c *controller) processLoop() {
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>        // å¼¹å‡ºç¬¬ä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶æ¶ˆè´¹
</span></span><span class=line><span class=cl>        // c.config.Process = sharedIndexInformer.HandleDeltas
</span></span><span class=line><span class=cl>        obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))
</span></span><span class=line><span class=cl>        if err != nil {
</span></span><span class=line><span class=cl>            if err == FIFOClosedError {
</span></span><span class=line><span class=cl>                return
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            if c.config.RetryOnError {
</span></span><span class=line><span class=cl>                // This is the safe way to re-enqueue.
</span></span><span class=line><span class=cl>                c.config.Queue.AddIfNotPresent(obj)
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=list-watch-èµ„æº-event-äº‹ä»¶å’Œ-deltas-event-ç”Ÿäº§>list watch èµ„æº Event äº‹ä»¶å’Œ deltas event ç”Ÿäº§</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Run starts a watch and handles watch events. Will restart the watch if it is closed.
</span></span><span class=line><span class=cl>// Run will exit when stopCh is closed.
</span></span><span class=line><span class=cl>func (r *Reflector) Run(stopCh &lt;-chan struct{}) {
</span></span><span class=line><span class=cl>    klog.V(3).Infof(&#34;Starting reflector %v (%s) from %s&#34;, r.expectedType, r.resyncPeriod, r.name)
</span></span><span class=line><span class=cl>    wait.Until(func() {
</span></span><span class=line><span class=cl>        if err := r.ListAndWatch(stopCh); err != nil {
</span></span><span class=line><span class=cl>            utilruntime.HandleError(err)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }, r.period, stopCh)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>controller å¯åŠ¨ reflectorï¼Œé—´éš” r.period æ—¶é—´ï¼Œé€šè¿‡ reflector.ListAndWatch å‡½æ•°è·å–æœ€æ–°äº‹ä»¶ã€‚</p><p>reflector.ListAndWatch ä»£ç è¾ƒé•¿ï¼Œå°±ä¸åœ¨æ­¤åˆ—å‡ºï¼Œç®€å•è®²ä¸€ä¸‹æ‰§è¡Œé€»è¾‘ï¼š</p><ol><li>é¦–å…ˆé€šè¿‡ List æ–¹æ³•ï¼Œä¸€æ¬¡æ€§æ‹‰å–æ‰€æœ‰èµ„æºï¼Œå¹¶è·å–æœ€æ–° resourceVersionï¼›</li><li>æ ¹æ®éœ€è¦ï¼Œå¯åŠ¨å®šæ—¶å¼‚æ­¥ List åç¨‹ï¼›</li><li>watch èµ„æºç›´åˆ° informer é€€å‡ºã€‚è°ƒç”¨ watchHandler è·å–èµ„æºå˜æ›´ï¼ˆwatch ä½¿ç”¨ http åè®® chunk æœºåˆ¶å®Œæˆï¼‰ã€‚å¯¹ response ååºåˆ—åŒ–æˆå†…éƒ¨èµ„æºå¯¹è±¡ <code>event.Object</code>ï¼Œæ ¹æ® <code>event.Type</code> æ‰§è¡Œ <code>r.store</code> æ›´æ–°ã€åˆ é™¤ã€æ–°å¢ï¼ˆå…¶ä¸­ï¼Œr.store ä¸º DeltaFIFOï¼‰ï¼›</li></ol><h2 id=ä¸»è¦å¯¹è±¡æ•°æ®ç»“æ„>ä¸»è¦å¯¹è±¡æ•°æ®ç»“æ„</h2><h3 id=controller>Controller</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Controller is a generic controller framework.
</span></span><span class=line><span class=cl>type controller struct {
</span></span><span class=line><span class=cl>    config         Config
</span></span><span class=line><span class=cl>    reflector      *Reflector
</span></span><span class=line><span class=cl>    reflectorMutex sync.RWMutex
</span></span><span class=line><span class=cl>    clock          clock.Clock
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=reflector>reflector</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Reflector watches a specified resource and causes all changes to be reflected in the given store.
</span></span><span class=line><span class=cl>type Reflector struct {
</span></span><span class=line><span class=cl>    // name identifies this reflector. By default it will be a file:line if possible.
</span></span><span class=line><span class=cl>    name string
</span></span><span class=line><span class=cl>    // metrics tracks basic metric information about the reflector
</span></span><span class=line><span class=cl>    metrics *reflectorMetrics
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // The type of object we expect to place in the store.
</span></span><span class=line><span class=cl>    expectedType reflect.Type
</span></span><span class=line><span class=cl>    // The destination to sync up with the watch source
</span></span><span class=line><span class=cl>    store Store
</span></span><span class=line><span class=cl>    // listerWatcher is used to perform lists and watches.
</span></span><span class=line><span class=cl>    listerWatcher ListerWatcher
</span></span><span class=line><span class=cl>    // period controls timing between one watch ending and
</span></span><span class=line><span class=cl>    // the beginning of the next one.
</span></span><span class=line><span class=cl>    period       time.Duration
</span></span><span class=line><span class=cl>    resyncPeriod time.Duration
</span></span><span class=line><span class=cl>    ShouldResync func() bool
</span></span><span class=line><span class=cl>    // clock allows tests to manipulate time
</span></span><span class=line><span class=cl>    clock clock.Clock
</span></span><span class=line><span class=cl>    // lastSyncResourceVersion is the resource version token last
</span></span><span class=line><span class=cl>    // observed when doing a sync with the underlying store
</span></span><span class=line><span class=cl>    // it is thread safe, but not synchronized with the underlying store
</span></span><span class=line><span class=cl>    lastSyncResourceVersion string
</span></span><span class=line><span class=cl>    // lastSyncResourceVersionMutex guards read/write access to lastSyncResourceVersion
</span></span><span class=line><span class=cl>    lastSyncResourceVersionMutex sync.RWMutex
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=sharedprocessor>sharedProcessor</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type sharedProcessor struct {
</span></span><span class=line><span class=cl>    listenersStarted bool
</span></span><span class=line><span class=cl>    listenersLock    sync.RWMutex
</span></span><span class=line><span class=cl>    listeners        []*processorListener
</span></span><span class=line><span class=cl>    syncingListeners []*processorListener
</span></span><span class=line><span class=cl>    clock            clock.Clock
</span></span><span class=line><span class=cl>    wg               wait.Group
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=processlistner>processListner</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type processorListener struct {
</span></span><span class=line><span class=cl>    nextCh chan interface{}
</span></span><span class=line><span class=cl>    addCh  chan interface{}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    handler ResourceEventHandler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // pendingNotifications is an unbounded ring buffer that holds all notifications not yet distributed.
</span></span><span class=line><span class=cl>    // There is one per listener, but a failing/stalled listener will have infinite pendingNotifications
</span></span><span class=line><span class=cl>    // added until we OOM.
</span></span><span class=line><span class=cl>    // TODO: This is no worse than before, since reflectors were backed by unbounded DeltaFIFOs, but
</span></span><span class=line><span class=cl>    // we should try to do something better.
</span></span><span class=line><span class=cl>    // RingGrowing æ˜¯ä¸€ä¸ªåŠ¨æ€å¢é•¿çš„å¾ªç¯é˜Ÿåˆ—
</span></span><span class=line><span class=cl>    pendingNotifications buffer.RingGrowing
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h2 id=ç–‘é—®>ç–‘é—®</h2><h3 id=ä¸ºä»€ä¹ˆéœ€è¦-waitforcachesync>ä¸ºä»€ä¹ˆéœ€è¦ waitForCacheSync</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (f *DeltaFIFO) HasSynced() bool {
</span></span><span class=line><span class=cl>    f.lock.Lock()
</span></span><span class=line><span class=cl>    defer f.lock.Unlock()
</span></span><span class=line><span class=cl>    return f.populated &amp;&amp; f.initialPopulationCount == 0
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p><code>waitForCacheSync</code> æœ€ç»ˆå›è°ƒç”¨ <code>DeltaFIFO.HasSynced</code> å‡½æ•°æ¥ç¡®å®šå½“å‰ cache ç¼“å­˜å…¨éƒ¨å†™å…¥ workqueue ä¸­ã€‚
åœ¨ è°ƒç”¨ <code>DeltaFIFO.Add</code>ï¼Œä»¥åŠ reflector list å®Œæˆèµ„æºï¼Œé€šè¿‡è°ƒç”¨ replace å†™å…¥ deltafifo æ—¶ä¼š <code>f.populated</code> ç½®ä¸º trueã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (f *DeltaFIFO) Add(obj interface{}) error {
</span></span><span class=line><span class=cl>    f.lock.Lock()
</span></span><span class=line><span class=cl>    defer f.lock.Unlock()
</span></span><span class=line><span class=cl>    f.populated = true
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (r *Reflector) ListAndWatch(stopCh &lt;-chan struct{}) error {
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    list, err := r.listerWatcher.List(options)
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    items, err := meta.ExtractList(list)
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    if err := r.syncWith(items, resourceVersion); err != nil {
</span></span><span class=line><span class=cl>        return fmt.Errorf(&#34;%s: Unable to sync list result: %v&#34;, r.name, err)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// syncWith replaces the store&#39;s items with the given list.
</span></span><span class=line><span class=cl>func (r *Reflector) syncWith(items []runtime.Object, resourceVersion string) error {
</span></span><span class=line><span class=cl>    found := make([]interface{}, 0, len(items))
</span></span><span class=line><span class=cl>    for _, item := range items {
</span></span><span class=line><span class=cl>        found = append(found, item)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return r.store.Replace(found, resourceVersion)
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (f *FIFO) Replace(list []interface{}, resourceVersion string) error {
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>    if !f.populated {
</span></span><span class=line><span class=cl>        f.populated = true
</span></span><span class=line><span class=cl>        f.initialPopulationCount = len(items)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    ......
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>è€Œ <code>f.initialPopulationCount</code> åªæœ‰åœ¨ list çš„æ‰€æœ‰èµ„æºéƒ½è¢« pop åï¼Œæ‰ä¼šè¢«é‡æ–°èµ‹å€¼ä¸º0ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (f *FIFO) Pop(process PopProcessFunc) (interface{}, error) {
</span></span><span class=line><span class=cl>    f.lock.Lock()
</span></span><span class=line><span class=cl>    defer f.lock.Unlock()
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>        // å¹¶å‘éªŒè¯
</span></span><span class=line><span class=cl>        for len(f.queue) == 0 {
</span></span><span class=line><span class=cl>            // When the queue is empty, invocation of Pop() is blocked until new item is enqueued.
</span></span><span class=line><span class=cl>            // When Close() is called, the f.closed is set and the condition is broadcasted.
</span></span><span class=line><span class=cl>            // Which causes this loop to continue and return from the Pop().
</span></span><span class=line><span class=cl>            if f.IsClosed() {
</span></span><span class=line><span class=cl>                return nil, FIFOClosedError
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            f.cond.Wait()
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        id := f.queue[0]
</span></span><span class=line><span class=cl>        f.queue = f.queue[1:]
</span></span><span class=line><span class=cl>        if f.initialPopulationCount &gt; 0 {
</span></span><span class=line><span class=cl>            f.initialPopulationCount--
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        .......
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>æ‰€ä»¥ï¼Œæ ¹æ®æºç åˆ†æï¼Œè°ƒç”¨ <code>waitForCacheSync</code> æ˜¯ç­‰å¾…ç¬¬ä¸€æ¬¡ list å®Œå…¨éƒ¨èµ„æºåï¼Œå¹¶ä¸” list çš„èµ„æºå…¨éƒ¨å†™å…¥åˆ° <code>workqueue</code> åå†å¯åŠ¨å¯¹åº”çš„ workï¼Œå¤„ç†äº‹ä»¶ã€‚è¿™æ ·ï¼Œé™ä½äº† list å¤§é‡èµ„æºæ—¶é«˜å¹¶å‘èµ„æºå¤„ç†èµ„æºé—®é¢˜ã€‚</p><h3 id=ä¸ºä»€ä¹ˆä½¿ç”¨-workqueue->ä¸ºä»€ä¹ˆä½¿ç”¨ workqueue ï¼Ÿ</h3><p>åœ¨ä¸€äº› informer demoï¼Œä»¥åŠ operator framework çš„ä»£ç é‡Œé¢ï¼Œéƒ½èƒ½çœ‹åˆ° Addã€Updateã€Delete äº‹ä»¶éƒ½è¦å…ˆå†™åˆ° workqueue ä¸­ï¼Œç„¶åå†å¼‚æ­¥æ¶ˆè´¹ã€‚ä¸çŸ¥é“æœ‰æ²¡æœ‰æ€è€ƒè¿‡ï¼Œä¸ºä»€ä¹ˆè¦åŠ å…¥ workqueueï¼Œè€Œä¸æ˜¯åœ¨äº‹ä»¶å‡½æ•°é‡Œç›´æ¥èµ·ä¸€ä¸ªåç¨‹æ¥å¤„ç†äº‹ä»¶?</p><p>é¦–å…ˆï¼Œè€ƒè™‘ä¸€ä¸ªåœºæ™¯ <code>Add -> Deleted -> Add</code>ï¼Œå¦‚æœå¹¶å‘å¤„ç†åŒä¸€ä¸ªèµ„æºï¼Œä¼šä¸ä¼šå­˜åœ¨é—®é¢˜ï¼Ÿé’ˆå¯¹é¡ºåºä¾èµ–é—®é¢˜ï¼Œæœ€ç®€å•æ–¹å¼å°±æ˜¯ä½¿ç”¨é˜Ÿåˆ—ã€‚é‚£å¹¶å‘æ‰§è¡Œé—®é¢˜å‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹ worqueue åº•å±‚ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p><p><code>k8s.io/client-go/util/workqueue</code> åŒ…æœ‰å¤šä¸ªæ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>default_rate_limiters.go    // é™é€Ÿå™¨ï¼ŒåŒ…å«ä¸¤ç§ï¼Œå…¨å±€é™é€Ÿï¼ˆBucketRateLimiterï¼‰å’Œé’ˆå¯¹ item é™é€Ÿï¼ˆItemExponentialFailureRateLimiterï¼‰
</span></span><span class=line><span class=cl>delaying_queue.go           // å»¶è¿Ÿé˜Ÿåˆ—ï¼Œæ”¯æŒå»¶è¿Ÿæ·»åŠ ï¼Œé˜Ÿåˆ—ä½¿ç”¨çš„ queue 
</span></span><span class=line><span class=cl>parallelizer.go             // å¹¶å‘æ§åˆ¶å™¨ï¼Œ
</span></span><span class=line><span class=cl>queue.go                    // é˜Ÿåˆ—ï¼Œä¼šå¯¹æ·»åŠ çš„ key å»é‡ï¼ŒåŒä¸€ä¸ª key åŒæ—¶åªä¼šå¤„ç†ä¸€æ¬¡
</span></span><span class=line><span class=cl>rate_limitting_queue.go     // é™é€Ÿé˜Ÿåˆ—åŒ…è£…å™¨ï¼Œç»„åˆå»¶è¿Ÿé˜Ÿåˆ—ã€
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä½¿ç”¨ informer æ—¶ï¼Œç»å¸¸çœ‹åˆ° <code>workqueue.NewRateLimitingQueue(workqueue.DefaultControllerRateLimiter())</code> ç”Ÿæˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œç¼“å­˜äº‹ä»¶å¯¹è±¡çš„ metaNamespaceKeyã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func NewRateLimitingQueue(rateLimiter RateLimiter) RateLimitingInterface {
</span></span><span class=line><span class=cl>    return &amp;rateLimitingType{
</span></span><span class=line><span class=cl>        DelayingInterface: NewDelayingQueue(),
</span></span><span class=line><span class=cl>        rateLimiter:       rateLimiter,
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func DefaultControllerRateLimiter() RateLimiter {
</span></span><span class=line><span class=cl>    return NewMaxOfRateLimiter(
</span></span><span class=line><span class=cl>        // é’ˆå¯¹å•ä¸ª item é™åˆ¶å¤„ç†é—´éš”ï¼Œæœ€å°ä¸º 5 æ¯«ç§’ï¼Œé‡æ–°å…¥é˜Ÿä¸€æ¬¡æŒ‡æ•°å¢é•¿ï¼Œæœ€å¤§ä¸º 1000 ç§’å»¶è¿Ÿ
</span></span><span class=line><span class=cl>        // backoff := float64(r.baseDelay.Nanoseconds()) * math.Pow(2, float64(exp))  exp æ˜¯é‡æ–°å…¥é˜Ÿçš„æ¬¡æ•°
</span></span><span class=line><span class=cl>        // if backoff &gt; math.MaxInt64 {
</span></span><span class=line><span class=cl>        //     return r.maxDelay
</span></span><span class=line><span class=cl>        // }
</span></span><span class=line><span class=cl>        NewItemExponentialFailureRateLimiter(5*time.Millisecond, 1000*time.Second),
</span></span><span class=line><span class=cl>        // ä½¿ç”¨ä»¤ç‰Œæ¡¶é™æµç®—æ³•ï¼Œé™åˆ¶æµé€Ÿä¸ºæ¯ç§’10ä¸ªï¼Œæ¡¶å¤§å°ä¸º 100 èƒ½å¤Ÿåº”å¯¹100çš„çªå‘
</span></span><span class=line><span class=cl>        &amp;BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(10), 100)},
</span></span><span class=line><span class=cl>    )
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p><code>delayQueue</code> ä½¿ç”¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå’Œå¸¦ç¼“å†² channelï¼ˆ1000ï¼‰å»¶è¿Ÿæ·»åŠ éœ€è¦é‡æ–°å…¥é˜Ÿçš„ itemï¼Œé˜Ÿåˆ—å®šä¹‰åœ¨ <code>queue.go</code> ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Type is a work queue (see the package comment).
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Type</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é€šè¿‡ slice å®ç°æœ‰åºé˜Ÿåˆ—ï¼Œåœ¨ queue ä¸­çš„ item å¿…å®šåœ¨ dirty ä¸­ä¹Ÿå­˜åœ¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>queue</span> <span class=p>[]</span><span class=nx>t</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Add é˜Ÿåˆ—å‰éœ€è¦å…ˆåœ¨è¿™ä¸ªé›†åˆä¸­æ·»åŠ ï¼Œç¡®ä¿é˜Ÿåˆ—ä¸­ item çš„å”¯ä¸€æ€§
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// processing ä¸­çš„ item ä¼šä¸´æ—¶å­˜åœ¨è¿™ä¸ªé‡Œé¢ï¼Œè°ƒç”¨ Type.Done æ‰ append åˆ° queue ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>dirty</span> <span class=nx>set</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è°ƒç”¨ Get çš„ item ä¿å­˜åœ¨è¿™ä¸ªé›†åˆä¸­ï¼ŒåŒæ—¶åœ¨ queue å’Œ dirty ä¸­åˆ é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>processing</span> <span class=nx>set</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜Ÿåˆ—ä½¿ç”¨ä¿¡å·é‡ä¿è¯è®¿é—®å®‰å…¨å’Œé€šçŸ¥ç­‰å¾…æ¶ˆè´¹çš„ worker
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cond</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸‹é¢äº†è§£ä¸€ä¸‹ï¼Œå…¥é˜Ÿå’Œå‡ºé˜Ÿçš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (q *Type) Get() (item interface{}, shutdown bool) {
</span></span><span class=line><span class=cl>    q.cond.L.Lock()
</span></span><span class=line><span class=cl>    defer q.cond.L.Unlock()
</span></span><span class=line><span class=cl>    for len(q.queue) == 0 &amp;&amp; !q.shuttingDown {
</span></span><span class=line><span class=cl>        q.cond.Wait()
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if len(q.queue) == 0 {
</span></span><span class=line><span class=cl>        // We must be shutting down.
</span></span><span class=line><span class=cl>        return nil, true
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // ä»£ç ç¼–è¯‘æ—¶ä¼šæœ‰ä¸´æ—¶å¯„å­˜å™¨ä¿å­˜ä¸­é—´å€¼
</span></span><span class=line><span class=cl>    // ç±»ä¼¼ temp=a, a=b, b=temp
</span></span><span class=line><span class=cl>    item, q.queue = q.queue[0], q.queue[1:]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q.metrics.get(item)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q.processing.insert(item)
</span></span><span class=line><span class=cl>    q.dirty.delete(item)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return item, false
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Add marks item as needing processing.
</span></span><span class=line><span class=cl>func (q *Type) Add(item interface{}) {
</span></span><span class=line><span class=cl>    q.cond.L.Lock()
</span></span><span class=line><span class=cl>    defer q.cond.L.Unlock()
</span></span><span class=line><span class=cl>    if q.shuttingDown {
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if q.dirty.has(item) {
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q.metrics.add(item)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q.dirty.insert(item)
</span></span><span class=line><span class=cl>    if q.processing.has(item) {
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    q.queue = append(q.queue, item)
</span></span><span class=line><span class=cl>    q.cond.Signal()
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>æ‰€ä»¥ï¼Œç»¼ä¸Šä½¿ç”¨ <code>workqueue</code> ä¿è¯äº†äº‹ä»¶èµ„æºçš„å”¯ä¸€æ€§ã€‚å¦å¤–ï¼Œæ¶ˆè´¹å¤±è´¥çš„ item å¯ä»¥é€šè¿‡è°ƒç”¨ <code>ratelimit.AddAfter</code> å’Œ <code>ratelimit.AddRateLimited</code> é¿å…äº† hotloop çš„é—®é¢˜ã€‚<code>AddRateLimited</code> æœ€ç»ˆå›è°ƒç”¨ <code>ItemFastSlowRateLimiter.When</code> å‡½æ•°ç¡®ä¿ failure item çš„å»¶è¿ŸæŒ‡æ•°å¢é•¿ã€‚</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/kubectl-exec-deepin/><div class=article-image><img src=/blog/p/kubectl-exec-deepin/_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_27040ddd7399aaf289c0ce70ee6592d9.jpg width=250 height=150 loading=lazy alt="Featured image of post ä» kubectl exec å¼‚å¸¸é—®é¢˜å¼€å§‹" data-key=kubectl-exec-deepin data-hash="md5-RvYejqai34/Fvx0koXxEpg=="></div><div class=article-details><h2 class=article-title>ä» kubectl exec å¼‚å¸¸é—®é¢˜å¼€å§‹</h2></div></a></article><article class=has-image><a href=/blog/p/ipvs-caused-problem/><div class=article-image><img src=/blog/p/ipvs-caused-problem/_hu958d513eeefe5556a31d065479ecc5ac_14205_7bffa90d1e66ca9b8184fda08a99dc7e.jpg width=250 height=150 loading=lazy alt="Featured image of post k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜" data-key=ipvs-caused-problem data-hash="md5-jq4GZk3fs+jcbgAHVstwOw=="></div><div class=article-details><h2 class=article-title>k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜</h2></div></a></article><article class=has-image><a href=/blog/p/how-endpoint-flush-ipvs/><div class=article-image><img src=/blog/p/how-endpoint-flush-ipvs/_huf941de4769045cdfa8c9ee7036519a2a_35369_36687b530fa140121781e790cfd060e7.jpg width=250 height=150 loading=lazy alt="Featured image of post endpoint æ›´æ–°å vip è½¬å‘å®ç°æ¢ç©¶" data-key=how-endpoint-flush-ipvs data-hash="md5-YBFrHM/IYy6aZffVHfPvwg=="></div><div class=article-details><h2 class=article-title>endpoint æ›´æ–°å vip è½¬å‘å®ç°æ¢ç©¶</h2></div></a></article><article class=has-image><a href=/blog/p/service-cause-failure/><div class=article-image><img src=/blog/p/service-cause-failure/_hu0a3f1163de68d0b9471979ebf0ecf11e_32400_a354a9a1f5102742bceb4ec236f4ce2f.jpg width=250 height=150 loading=lazy alt="Featured image of post pod é”€æ¯è¿‡ç¨‹å¼•èµ·çŸ­æ—¶æœåŠ¡ä¸å¯ç”¨" data-key=service-cause-failure data-hash="md5-rC+UhC7sa7h6Y66uIugvQQ=="></div><div class=article-details><h2 class=article-title>pod é”€æ¯è¿‡ç¨‹å¼•èµ·çŸ­æ—¶æœåŠ¡ä¸å¯ç”¨</h2></div></a></article><article class=has-image><a href=/blog/p/pod-pending-with-enough-resources/><div class=article-image><img src=/blog/p/pod-pending-with-enough-resources/sleep-boy.ba540b47bff96318db80025530254292_hud07293a026e0ecb8feb93a2c733978af_122481_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post é›†ç¾¤èµ„æºå……è¶³æƒ…å†µ Pod å‡ºç° schedulfailed" data-key=pod-pending-with-enough-resources data-hash="md5-ulQLR7/5YxjbgAJVMCVCkg=="></div><div class=article-details><h2 class=article-title>é›†ç¾¤èµ„æºå……è¶³æƒ…å†µ Pod å‡ºç° schedulfailed</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 jason's åšå®¢</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>