<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="代码级别深入研究 kubectl exec 底层逻辑"><title>从 kubectl exec 异常问题开始</title><link rel=canonical href=https://jasonrd.github.io/blog/p/kubectl-exec-deepin/><link rel=stylesheet href=/blog/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="从 kubectl exec 异常问题开始"><meta property="og:description" content="代码级别深入研究 kubectl exec 底层逻辑"><meta property="og:url" content="https://jasonrd.github.io/blog/p/kubectl-exec-deepin/"><meta property="og:site_name" content="jason's 博客"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-03-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-01T00:00:00+00:00"><meta property="og:image" content="https://jasonrd.github.io/blog/p/kubectl-exec-deepin/helena-hertz-wWZzXlDpMog-unsplash.jpg"><meta name=twitter:site content="@jasonxie666"><meta name=twitter:creator content="@jasonxie666"><meta name=twitter:title content="从 kubectl exec 异常问题开始"><meta name=twitter:description content="代码级别深入研究 kubectl exec 底层逻辑"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jasonrd.github.io/blog/p/kubectl-exec-deepin/helena-hertz-wWZzXlDpMog-unsplash.jpg"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/avatar_hu92a1f0f4dac05816138a9efb01424f59_787601_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>jason's 博客</a></h1><h2 class=site-description>Welcom</h2></div></header><ol class=social-menu><li><a href=https://github.com/JasonRD target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/jasonxie666 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>主页</span></a></li><li><a href=/blog/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li><a href=/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/blog/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://jasonrd.github.io/blog/en/>English</option><option value=https://jasonrd.github.io/blog/ selected>中文</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#问题现象>问题现象</a></li><li><a href=#排查过程>排查过程</a></li><li><a href=#继续深挖>继续深挖</a><ol><li><a href=#kubectl-exec-的执行过程>kubectl exec 的执行过程</a></li><li><a href=#如何避免端口冲突>如何避免端口冲突</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/p/kubectl-exec-deepin/><img src=/blog/p/kubectl-exec-deepin/helena-hertz-wWZzXlDpMog-unsplash_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_800x0_resize_q75_box.jpg srcset="/blog/p/kubectl-exec-deepin/helena-hertz-wWZzXlDpMog-unsplash_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_800x0_resize_q75_box.jpg 800w, /blog/p/kubectl-exec-deepin/helena-hertz-wWZzXlDpMog-unsplash_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_1600x0_resize_q75_box.jpg 1600w" width=800 height=600 loading=lazy alt="Featured image of post 从 kubectl exec 异常问题开始"></a></div><div class=article-details><header class=article-category><a href=/blog/categories/kubernetes/ style=background-color:#2a9d8f;color:#fff>kubernetes</a>
<a href=/blog/categories/runtime/>runtime</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/kubectl-exec-deepin/>从 kubectl exec 异常问题开始</a></h2><h3 class=article-subtitle>代码级别深入研究 kubectl exec 底层逻辑</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Mar 01, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 3 分钟</time></div></footer></div></header><section class=article-content><h2 id=问题现象>问题现象</h2><p>最近，在工作想要使用 kubectl exec 进入容器排查问题，结果返回下面异常：</p><p><img src=/blog/p/kubectl-exec-deepin/img/exec-failure.png width=2828 height=158 srcset="/blog/p/kubectl-exec-deepin/img/exec-failure_hufe0606b0bd44839a8e6bff7d797c72f2_189000_480x0_resize_box_3.png 480w, /blog/p/kubectl-exec-deepin/img/exec-failure_hufe0606b0bd44839a8e6bff7d797c72f2_189000_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=1789 data-flex-basis=4295px></p><h2 id=排查过程>排查过程</h2><p>我们知道 kubectl exec 的执行链路是 client -> kube-apiserver -> kubelet -> docker。</p><p>登录 Kubelet 宿主机查看 kubelet 错误日志，发现有相同的报错日志，这说明是 kubelet 和 docker 之间链路又问题。通过 kubelet 日志中不能定为到问题具体原因。然后，我们试图通过抓包，希望在数据包中能发现一些线索。</p><p>在抓包数据结果中我们发现关键字为 exec 的请求，该会话的目的地址为 A:20880, http header 中 Host 为 B:10250 （也就是是物理机上 kubelet 的 httpserver 地址）。我们查询 A 这个IP，发现是业务应用的容器 IP。</p><p>这就比较奇怪了，正常 apiserver 发送 exec 请求为什么转发到了容器的 20880 端口。并且数据包中包含 kubectl (&ldquo;User-Agent: kubectl&rdquo;) http header。难道 kubectl exec 请求发送到 docker 的请求（xxxx/exec/token）被转发到了容器。通过再次尝试执行 kubectl exec 并抓包，发现执行命令和发送到 20880 端口请求匹配，这验证了我们的猜测。</p><p>到此就把问题范围缩小到宿主机网络上，我们知道 kube-proxy 会通过 ipvs 或 iptables 对创建的 nodeport 或 service vip 的请求进行拦截和转发。我们查看 conntrack 请求记录：</p><p><img src=/blog/p/kubectl-exec-deepin/img/exec-conntrack.png width=2706 height=64 srcset="/blog/p/kubectl-exec-deepin/img/exec-conntrack_huca2d8b10dc5e6cf266293d7184a5d6ec_84921_480x0_resize_box_3.png 480w, /blog/p/kubectl-exec-deepin/img/exec-conntrack_huca2d8b10dc5e6cf266293d7184a5d6ec_84921_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=4228 data-flex-basis=10147px></p><p>发现一条请求 127.0.0.1:33589 的记录，并且转发到的地址 A:20880 也和我们抓包的结果匹配。然后查看 33589 端口，发现该端口就是被 kubelet 占用。然后，我们查询 service，发现 33589 端口同时是 B 容器的应用 service 的 nodeport。到此问题根本原因定位到了，nodeport 端口和 kubelet 启动的转发端口冲突了，导致发送 exec 请求转发到了应用容器的 20880 端口（dubbo端口）。</p><h2 id=继续深挖>继续深挖</h2><p>事情到此并没有结束，上面我们只是定位到了具体问题原因。其实还存在两个问题：</p><ol><li>对 kubectl exec 的执行过程还没没挖透；</li><li>如何避免该问题？</li></ol><h3 id=kubectl-exec-的执行过程>kubectl exec 的执行过程</h3><p>问题没有快速定位，主要原因还是对 kubectl exec 执行流程不熟。下面来了解一下 kubectl 是怎么执行的。</p><p>本文基于 1.14.6 源码进行研究。</p><p>首先，简单了解一下 kubelet 架构：</p><p><img src=/blog/p/kubectl-exec-deepin/img/kubelet-arch.png width=1576 height=368 srcset="/blog/p/kubectl-exec-deepin/img/kubelet-arch_hu6568dec694f664b38c0d8a13d58d2338_47592_480x0_resize_box_3.png 480w, /blog/p/kubectl-exec-deepin/img/kubelet-arch_hu6568dec694f664b38c0d8a13d58d2338_47592_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=428 data-flex-basis=1027px></p><p>kubelet 中有上面几个部分：container manager、dockershim、http server、streaming server。kubelet 早期直接调用 docker api 管理容器，后来为了适配更多的 runtime 抽象出了一个接入层 cri。同时，为了兼容 docker 的 API，kubelet 代码中实现了这个叫 dockershim 的部分。这样就对上层屏蔽了底层 runtime。http server 通常使用 10250 对外提供 API 服务。streaming server 是需要和容器进行交互时的一个代理服务。</p><p>在默认情况下，用户执行 kubectl exec 简化流程如下：</p><p><img src=/blog/p/kubectl-exec-deepin/img/kubelet-streamer.png width=1494 height=1000 srcset="/blog/p/kubectl-exec-deepin/img/kubelet-streamer_hu77ee1ab196b176433e041293050f2664_131743_480x0_resize_box_3.png 480w, /blog/p/kubectl-exec-deepin/img/kubelet-streamer_hu77ee1ab196b176433e041293050f2664_131743_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=149 data-flex-basis=358px></p><ol><li>terminal 中键入 kubectl exec xxx 指令，kubectl 发送请求到 apiserver https://apiserver/api/v1/namespaces/{ns}/pods/{pod}/exec?command=bash&container=dragon-claw&stdin=true&stdout=true&tty=true；</li><li>apiserver 接到请求后，将请求转发到 kubelet， node:10250/api/v1/exec/{ns}/{podid}/{container}。kubelet httpserver 接收到请求后：<ul><li>首先，向 dockershim 发起 getExec 请求，返回一个流地址 url （exec/{token}）；</li><li>然后，kubelet 请求 exec/xxxx url 到 streaming server，streaming server 接收到请求后，response upgrade 将连接升级成为 spdy 或 ws 连接；</li></ul></li><li>kubelet 收到 upgrade reponse 后，将该 reponse 直接返回给 apiserver，到此 apiserver -> kubelet -> streaming server -> docker 之间整个通道建立完成；</li><li>到此，用户可以在 terminal 中键入命令在容器中执行；</li></ol><p><img src=/blog/p/kubectl-exec-deepin/img/exec-uml.jpg width=2536 height=1506 srcset="/blog/p/kubectl-exec-deepin/img/exec-uml_hu2f1e02e515e351c311ec896043222feb_281732_480x0_resize_q75_box.jpg 480w, /blog/p/kubectl-exec-deepin/img/exec-uml_hu2f1e02e515e351c311ec896043222feb_281732_1024x0_resize_q75_box.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=168 data-flex-basis=404px></p><p>其中， streaming server 是 kubelet 和 docker 之间的一个桥梁，他负责将请求转发给 docker（或者其他 runtime）。kubelet 访问 streaming server 的地址就是 127.0.0.1:{streaming sever port}。</p><p><strong>而我们遇到问题中端口冲突，就是 streaming server 端口和 nodeport 冲突。kubelet 拿到 exec url 后，命中本地 iptables 规则，然后请求被转发到了 nodeport 关联的容器，返回上述错误。</strong></p><p>在源码研究过程中，参数 &ndash;redirect-container-streaming 引起了我们的注意：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (s *Server) getExec(request *restful.Request, response *restful.Response) {
</span></span><span class=line><span class=cl>    .... 省略若干代码....
</span></span><span class=line><span class=cl>    url, err := s.host.GetExec(podFullName, params.podUID, params.containerName, params.cmd, *streamOpts)
</span></span><span class=line><span class=cl>    if err != nil {
</span></span><span class=line><span class=cl>        streaming.WriteError(err, response.ResponseWriter)
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if s.redirectContainerStreaming {
</span></span><span class=line><span class=cl>        http.Redirect(response.ResponseWriter, request.Request, url.String(), http.StatusFound)
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    proxyStream(response.ResponseWriter, request.Request, url)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>该参数开启后会并不会进行 proxyStream。而是直接向 apiserver 发送 302 跳转，流程变为如下：</p><p><img src=/blog/p/kubectl-exec-deepin/img/kubelet-nostreamer.png width=1508 height=1000 srcset="/blog/p/kubectl-exec-deepin/img/kubelet-nostreamer_hu45498cf6e0b95b67adcec0e537e81e4b_116430_480x0_resize_box_3.png 480w, /blog/p/kubectl-exec-deepin/img/kubelet-nostreamer_hu45498cf6e0b95b67adcec0e537e81e4b_116430_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=150 data-flex-basis=361px></p><p>该参数说明，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>--redirect-container-streaming  Enables container streaming redirect. If false, kubelet will proxy container streaming data between apiserver and container runtime; if true, kubelet will return an http redirect to apiserver, and apiserver will access container runtime directly. The proxy approach is more secure, but introduces some overhead. The redirect approach is more performant, but less secure because the connection between apiserver and container runtime may not be authenticated.
</span></span></code></pre></td></tr></table></div></div><p>另外，在 1.18 版本中我们发现该参数即将废弃，社区中已经在 kep <a class=link href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1558-streaming-proxy-redirects#dependence-on-apiserver-redirects target=_blank rel=noopener>Cleaning up container streaming requests</a>中详细说明了后续下线计划（1.18 进行下线提示、1.20版本参数失效、1.22 参数被删除）。后续 apiserver 无法直接和 dockershim 通信。</p><h3 id=如何避免端口冲突>如何避免端口冲突</h3><p>经过源码阅读，我们了解了执行 kube exec 的流程，通过关闭 streaming server 可以避免 streaming server 端口和 nodeport 冲突。但是该方案只能在 1.20 版本前的集群中使用。</p><p>另外，进一步思考，如果其他进程使用了一个随机端口是否也会出现该问题呢？</p><p>还是有一定冲突概率的，在 <a class=link href=https://github.com/kubernetes/kubernetes/issues/85418 target=_blank rel=noopener>#85418</a> issue 中就有人提出了该问题，从相关讨论中推荐解决方法是通过宿主机预留端口（net.ipv4.ip_local_port_range）解决。k8s apiserver 默认的 nodeport 端口范围为 30000-32767 （通过 &ndash;service-node-port-range 参数配置），一般宿主机 net.ipv4.ip_local_port_range 默认范围为 32768-60999。而我们出现冲突，因为使用的某云 k8s 集群修改了 apiserver 参数为 30000-50000，导致出现端口冲突问题。</p><p>其实，kube-proxy 为了避免端口冲突的问题，运行过程会监听所有的 nodeport 端口。但是，这存在一个鸡生蛋的问题。如果某个 nodeport 分配前已经被其他应用占用，或者 kube-proxy 重启，还是会存在端口冲突的问题。在 <a class=link href=https://github.com/kubernetes/kubernetes/issues/100643 target=_blank rel=noopener>#100643</a> issue 中也进行了相关讨论，希望后续能有完美的解决方案。</p><p>综上，目前解决方案下面几种：</p><ol><li>1.20 前版本可以通过 &ndash;redirect-container-streaming 关闭 steaming server，避免 kubelet 和 nodeport 端口冲突；</li><li>修改系统参数和 apiserver 端口范围，保证和宿主机随机端口范围不重合；</li><li>其他技术，例如 <a class=link href=https://github.com/kubernetes/kubernetes/issues/100643 target=_blank rel=noopener>#100643</a> issue 中提出的 ebpf。</li></ol><h2 id=总结>总结</h2><p>通过一个生产 <code>kubectl exec</code>异常问题，我们了解了执行 exec 命令后，整个底层转发逻辑：</p><ol><li>apiserver 查询到 pod 所在 node ip，通过 nodeip:10250 端口向 kubelet 发起请求；</li><li>kubelet 接收到请求后，向本地 runtime 获取 exec url。然后，1.20 之前会基于参数 &ndash;redirect-container-streaming 有两种处理流程：<ol><li>开启参数，通过 302 跳转方式，将 apiserver 请求重定向到 exec url；</li><li>关闭参数，会先直接和 runtime 建立 exec 通道，然后将 apiserver 请求升级为 spdy 或 ws 连接；</li></ol></li><li>后续 apisever 和 runtime 通道建立完成，client 就可以在 terminal 上执行命令了。</li></ol></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/ipvs-caused-problem/><div class=article-image><img src=/blog/p/ipvs-caused-problem/_hu958d513eeefe5556a31d065479ecc5ac_14205_7bffa90d1e66ca9b8184fda08a99dc7e.jpg width=250 height=150 loading=lazy alt="Featured image of post k8s 环境中 ipvs 带来的问题" data-key=ipvs-caused-problem data-hash="md5-jq4GZk3fs+jcbgAHVstwOw=="></div><div class=article-details><h2 class=article-title>k8s 环境中 ipvs 带来的问题</h2></div></a></article><article class=has-image><a href=/blog/p/how-endpoint-flush-ipvs/><div class=article-image><img src=/blog/p/how-endpoint-flush-ipvs/_huf941de4769045cdfa8c9ee7036519a2a_35369_36687b530fa140121781e790cfd060e7.jpg width=250 height=150 loading=lazy alt="Featured image of post endpoint 更新后 vip 转发实现探究" data-key=how-endpoint-flush-ipvs data-hash="md5-YBFrHM/IYy6aZffVHfPvwg=="></div><div class=article-details><h2 class=article-title>endpoint 更新后 vip 转发实现探究</h2></div></a></article><article class=has-image><a href=/blog/p/service-cause-failure/><div class=article-image><img src=/blog/p/service-cause-failure/_hu0a3f1163de68d0b9471979ebf0ecf11e_32400_a354a9a1f5102742bceb4ec236f4ce2f.jpg width=250 height=150 loading=lazy alt="Featured image of post pod 销毁过程引起短时服务不可用" data-key=service-cause-failure data-hash="md5-rC+UhC7sa7h6Y66uIugvQQ=="></div><div class=article-details><h2 class=article-title>pod 销毁过程引起短时服务不可用</h2></div></a></article><article class=has-image><a href=/blog/p/pod-pending-with-enough-resources/><div class=article-image><img src=/blog/p/pod-pending-with-enough-resources/sleep-boy.ba540b47bff96318db80025530254292_hud07293a026e0ecb8feb93a2c733978af_122481_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 集群资源充足情况 Pod 出现 schedulfailed" data-key=pod-pending-with-enough-resources data-hash="md5-ulQLR7/5YxjbgAJVMCVCkg=="></div><div class=article-details><h2 class=article-title>集群资源充足情况 Pod 出现 schedulfailed</h2></div></a></article><article class=has-image><a href=/blog/p/gpu-start-failure/><div class=article-image><img src=/blog/p/gpu-start-failure/_huf941de4769045cdfa8c9ee7036519a2a_35369_36687b530fa140121781e790cfd060e7.jpg width=250 height=150 loading=lazy alt="Featured image of post kubelet 开启 static 引发 gpu 容器部署异常" data-key=gpu-start-failure data-hash="md5-YBFrHM/IYy6aZffVHfPvwg=="></div><div class=article-details><h2 class=article-title>kubelet 开启 static 引发 gpu 容器部署异常</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 jason's 博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>