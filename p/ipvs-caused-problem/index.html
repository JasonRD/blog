<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ä¸Šç¯‡ä¸­åˆ†æ vip è½¬å‘å®ç°ï¼Œæœ¬æ–‡æ·±åº¦æ¢ç©¶ ipvs çš„ä¸åˆç†å‚æ•°é…ç½®ï¼Œä¼šå¯¼è‡´å“ªäº›é—®é¢˜"><title>k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜</title><link rel=canonical href=https://jasonrd.github.io/blog/p/ipvs-caused-problem/><link rel=stylesheet href=/blog/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜"><meta property="og:description" content="ä¸Šç¯‡ä¸­åˆ†æ vip è½¬å‘å®ç°ï¼Œæœ¬æ–‡æ·±åº¦æ¢ç©¶ ipvs çš„ä¸åˆç†å‚æ•°é…ç½®ï¼Œä¼šå¯¼è‡´å“ªäº›é—®é¢˜"><meta property="og:url" content="https://jasonrd.github.io/blog/p/ipvs-caused-problem/"><meta property="og:site_name" content="jason's åšå®¢"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-01-05T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-05T00:00:00+00:00"><meta property="og:image" content="https://jasonrd.github.io/blog/p/ipvs-caused-problem/matt-le-SJSpo9hQf7s-unsplash.jpg"><meta name=twitter:site content="@jasonxie666"><meta name=twitter:creator content="@jasonxie666"><meta name=twitter:title content="k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜"><meta name=twitter:description content="ä¸Šç¯‡ä¸­åˆ†æ vip è½¬å‘å®ç°ï¼Œæœ¬æ–‡æ·±åº¦æ¢ç©¶ ipvs çš„ä¸åˆç†å‚æ•°é…ç½®ï¼Œä¼šå¯¼è‡´å“ªäº›é—®é¢˜"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jasonrd.github.io/blog/p/ipvs-caused-problem/matt-le-SJSpo9hQf7s-unsplash.jpg"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/avatar_hu92a1f0f4dac05816138a9efb01424f59_787601_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>jason's åšå®¢</a></h1><h2 class=site-description>Welcom</h2></div></header><ol class=social-menu><li><a href=https://github.com/JasonRD target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/jasonxie666 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>ä¸»é¡µ</span></a></li><li><a href=/blog/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>å…³äº</span></a></li><li><a href=/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/blog/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://jasonrd.github.io/blog/en/>English</option><option value=https://jasonrd.github.io/blog/ selected>ä¸­æ–‡</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#åˆ†æè¿‡ç¨‹>åˆ†æè¿‡ç¨‹</a></li><li><a href=#è¿›ä¸€æ­¥æ·±æŒ–>è¿›ä¸€æ­¥æ·±æŒ–</a><ol><li><a href=#netipv4vsconn_reuse_mode-å¼€å¯å’Œå…³é—­å½±å“>net.ipv4.vs.conn_reuse_mode å¼€å¯å’Œå…³é—­å½±å“</a></li><li><a href=#å•æ ¸æ€§èƒ½æ›´ä¼˜>å•æ ¸æ€§èƒ½æ›´ä¼˜ï¼Ÿ</a></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/p/ipvs-caused-problem/><img src=/blog/p/ipvs-caused-problem/matt-le-SJSpo9hQf7s-unsplash_hu958d513eeefe5556a31d065479ecc5ac_14205_800x0_resize_q75_box.jpg srcset="/blog/p/ipvs-caused-problem/matt-le-SJSpo9hQf7s-unsplash_hu958d513eeefe5556a31d065479ecc5ac_14205_800x0_resize_q75_box.jpg 800w, /blog/p/ipvs-caused-problem/matt-le-SJSpo9hQf7s-unsplash_hu958d513eeefe5556a31d065479ecc5ac_14205_1600x0_resize_q75_box.jpg 1600w" width=800 height=533 loading=lazy alt="Featured image of post k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜"></a></div><div class=article-details><header class=article-category><a href=/blog/categories/kubernetes/ style=background-color:#2a9d8f;color:#fff>kubernetes</a>
<a href=/blog/categories/ipvs/>ipvs</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/ipvs-caused-problem/>k8s ç¯å¢ƒä¸­ ipvs å¸¦æ¥çš„é—®é¢˜</a></h2><h3 class=article-subtitle>ä¸Šç¯‡ä¸­åˆ†æ vip è½¬å‘å®ç°ï¼Œæœ¬æ–‡æ·±åº¦æ¢ç©¶ ipvs çš„ä¸åˆç†å‚æ•°é…ç½®ï¼Œä¼šå¯¼è‡´å“ªäº›é—®é¢˜</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 05, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 6 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=èƒŒæ™¯>èƒŒæ™¯</h2><p>è¿‘æ—¥ï¼Œæ”¶åˆ°ä¸šåŠ¡åŒå­¦åé¦ˆï¼Œåœ¨è¿›è¡Œåœ¨çº¿æ¨ç†ä¸šåŠ¡æ—¶å‘ç°ï¼šéƒ¨ç½²åˆ° Kubernetes çš„æœåŠ¡ï¼Œå‹æµ‹è¯•æ€§èƒ½å‡ºç°æ•°é‡çº§ä¸‹é™é—®é¢˜ï¼ˆåªèƒ½è¾¾åˆ° 200 QPSï¼‰ï¼Œä¸šåŠ¡æ€§èƒ½å°†éš¾ä»¥æ»¡è¶³å®¢æˆ·å®é™…éœ€æ±‚ã€‚</p><p></p><p>æˆ‘ä»¬å¯¹è¯¥é—®é¢˜è¿›è¡Œäº†è¯¦ç»†åˆ†æï¼Œé€šè¿‡å¯¹å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼Œæœ€ç»ˆå®¹å™¨ç¯å¢ƒæ€§èƒ½å¯ä»¥è¾¾åˆ° 2000 QPSã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ä¼šåˆ†äº«æ•´ä¸ªé—®é¢˜åˆ†æå’Œä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œå¹¶ä¸”å¯¹å…¶ä¸­æ¶‰åŠåˆ°çš„éƒ¨åˆ†å…³é”®æ€§é—®é¢˜è¿›è¡Œå‰–æã€‚å¦å¤–ï¼Œä¸ºä½• kubernetes ä¼˜åŒ–åæœ€é«˜è¾¾åˆ° 2000 qpsï¼Œè€Œ docker run ç¯å¢ƒèƒ½å¤Ÿè¾¾åˆ° 4000 qpsï¼Ÿä¸‹æ–‡ä¸­ä¹Ÿä¼šç»™å‡ºç­”æ¡ˆã€‚</p><h2 id=åˆ†æè¿‡ç¨‹>åˆ†æè¿‡ç¨‹</h2><p>æ ¹æ®ä¸šåŠ¡åŒå­¦åé¦ˆï¼Œå‹æµ‹ç«¯ï¼ˆ10.58.14.13ï¼‰ä½¿ç”¨ kubernetes service å’Œ nodeport ä¸¤ç§æ–¹å¼ï¼Œéƒ½ä¼šå‡ºç° QPS æ€¥å‰§é™ä½çš„é—®é¢˜ã€‚</p><p>è§‚å¯Ÿ QPS é™ä½ä¸º 200 æ—¶ ab å‹æµ‹è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹å‡º rt å¤§éƒ¨åˆ†æ¶ˆè€—åœ¨ connect é˜¶æ®µï¼ˆæœ€å¤§è¾¾åˆ°1sï¼‰ï¼Œä¹Ÿå°±æ˜¯å‹æµ‹æœºï¼ˆ10.58.14.13ï¼‰å’Œ 10.58.14.15 ä¸Šçš„ Kubernetes å®¹å™¨å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼š</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-1.png width=1026 height=526 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-1_hua09781a0f876d3e05b8d14a9bbb027ac_301023_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-1_hua09781a0f876d3e05b8d14a9bbb027ac_301023_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=195 data-flex-basis=468px></p><p>å‡ºç°è¿™ç§ç°è±¡ï¼Œå¯ä»¥ä»ä¸‹é¢ä¸¤ä¸ªæ–¹é¢è¿›è¡Œåˆ†æï¼š</p><ol><li>14.13 -> 14.15 ä¹‹é—´ç½‘ç»œå­˜åœ¨é—®é¢˜ï¼›</li><li>14.15 ç³»ç»Ÿå±‚é¢é—®é¢˜ï¼›</li></ol><p>ä¸ºäº†æ’é™¤ç½‘ç»œæ–¹é¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ 14.15 ä¸»æœºä¸Šä½¿ç”¨ Pod IP è¿›è¡Œå‹æµ‹ï¼Œå‹æµ‹ QPS ä¸º 2000 å·¦å³ã€‚ç„¶åï¼ŒåŒæ ·åœ¨ 14.15 ä¸»æœºä¸Šä½¿ç”¨ service ip è¿›è¡Œå‹æµ‹ï¼Œæˆ‘ä»¬å‘ç°åœ¨å¤§çº¦ 30000 è¯·æ±‚åï¼Œå’Œä¹‹å‰ä¸šåŠ¡åŒå­¦æè¿°ä¸€è‡´ï¼šQPS ç”± 2000 é™ä½åˆ°ä¸åˆ° 120ã€‚å‹æµ‹æ—¶è§‚å¯Ÿç³»ç»Ÿè´Ÿè½½å’Œä¸šåŠ¡å®¹å™¨ cpu éƒ½éå¸¸ä½ï¼Œè¿™è¯´æ˜é—®é¢˜å’Œ Kubernetes ç½‘ç»œæ¶æ„æœ‰å…³ã€‚å…ˆçœ‹ä¸€ä¸‹ä½¿ç”¨ Kubernetes service è¯·æ±‚å’Œ Pod ip ä¸¤ç§æ–¹å¼æœ‰å“ªäº›ä¸åŒï¼š</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-2.png width=880 height=316 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-2_hu75f0acaa5e34183215e50bea0bf5348b_87843_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-2_hu75f0acaa5e34183215e50bea0bf5348b_87843_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=278 data-flex-basis=668px></p><p>Service ip æ˜¯ Kubernetes åœ¨ IP æ± ä¸­é€‰å–çš„ä¸€ä¸ª VIPï¼Œæ¯ä¸ª VIP ä¼šå…³è”å¤šä¸ª POD å®ä¾‹ã€‚ä¸ºäº†èƒ½å¤Ÿé€šè¿‡ VIP è¯·æ±‚åˆ°å…·ä½“çš„å®¹å™¨ï¼ŒKubernetes ç½‘ç»œæ’ä»¶ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåšä¸€äº›å¤„ç†ï¼Œç›®å‰å¸¸ç”¨çš„ä¸¤ç§æ¨¡å¼æ˜¯ iptables æˆ– ipvsã€‚æˆ‘ä»¬æœ¬æ¬¡å‡ºé—®é¢˜åœºæ™¯ä½¿ç”¨çš„æ˜¯ ipvs æ¨¡å¼ã€‚åœ¨ ipvs æ¨¡å¼ä¸‹ï¼Œå½“å®¢æˆ·ç«¯ä½¿ç”¨ VIP è¯·æ±‚æ—¶ï¼Œä¼šç»è¿‡å†…æ ¸ ipvs æ¨¡å—è¿›è¡Œæ•°æ®å¤„ç†ï¼Œæ‰å°†æµé‡è½¬å‘åˆ°å…·ä½“çš„å®¹å™¨å®ä¾‹ã€‚</p><p>é€šè¿‡å¯¹æ¯”å‘ç°ï¼Œæˆ‘ä»¬æœ¬æ¬¡å‡ºç°é—®é¢˜åº”è¯¥å°±æ˜¯ ipvs æ¨¡å—ä¸Šã€‚</p><p>ä¸ºäº†æ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ Kubernetes ä¸­éƒ¨ç½²äº†ä¸€ä¸ªç®€å•çš„ http server Podï¼Œç„¶ååœ¨ Pod æ‰€åœ¨ä¸»æœºä¸Šè¿›è¡Œå‹æµ‹æ¥è¿›è¡Œé—®é¢˜åˆ†æã€‚</p><p>åœ¨ linux ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šå·¥å…·å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ¥æŸ¥çœ‹ ipvs ç®¡ç†çš„è¿æ¥ï¼Œåœ¨å‹æµ‹è¿‡ç¨‹ä¸­ä½¿ç”¨ ipvsadm è§‚å¯Ÿçœ‹åˆ° vip å…³è”çš„ rs åç«¯è¿æ¥æ•°çš„å˜åŒ–ï¼š</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-3.png width=3058 height=1260 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-3_huc84b6d47cb01a67fddf9dc8103a4ec0c_1927321_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-3_huc84b6d47cb01a67fddf9dc8103a4ec0c_1927321_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=242 data-flex-basis=582px></p><p>è¿™é‡Œç®€å•ä»‹ç»æ‰§è¡Œ ipvsadm - L -t vip:port è¿”å›çš„ä¿¡æ¯ä¸­å‡ ä¸ªå­—æ®µçš„å«ä¹‰ï¼š</p><ol><li>Weight æµé‡è½¬å‘ç»™æŸä¸ªåç«¯å®ä¾‹æ‰€å çš„æƒé‡ï¼Œå½“è¯¥å€¼ä¸º 0 æ—¶æ–°è¿æ¥å°±ä¸ä¼šè½¬å‘åˆ°å¯¹åº”çš„åç«¯ ip ä¸Šï¼›</li><li>ActionConn æ˜¯æ´»åŠ¨è¿æ¥æ•°ï¼Œä¹Ÿå°±æ˜¯tcpè¿æ¥çŠ¶æ€çš„ ESTABLISHEDï¼›</li><li>InActConn æ˜¯æŒ‡é™¤äº†ESTABLISHEDä»¥å¤–çš„,æ‰€æœ‰çš„å…¶å®ƒçŠ¶æ€çš„tcpè¿æ¥ï¼›</li></ol><p>æˆ‘ä»¬åœ¨å‹æµ‹å¼€å§‹ server cpu åˆ©ç”¨èƒ½å¤Ÿè·‘æ»¡ï¼Œéšç€ InActConn æ•°é‡çš„å¢é•¿ server çš„ cpu åˆ©ç”¨ç‡ä¹Ÿå¼€å§‹ä¸‹æ»‘ï¼Œæœ€åå½“ InActConn ç»´æŒåˆ° 32000 å¤šæ—¶ï¼Œhttp server çš„ cpu åˆ©ç”¨ç‡åªæœ‰ 3%ï¼ŒInActConn æ•°æ•°å­—å‡ ä¹æ²¡æœ‰å˜åŒ–ã€‚æ˜¾ç„¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚æ²¡æœ‰åˆ°åº”ç”¨å±‚ã€‚</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-4.png width=2182 height=1778 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-4_hud9f2fb6970bb36d62dcb40deb5656e8d_1387653_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-4_hud9f2fb6970bb36d62dcb40deb5656e8d_1387653_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=122 data-flex-basis=294px></p><p>ä¹‹å‰åœ¨ Kubernetes ç¤¾åŒºçœ‹åˆ°è¿‡ä¸€ä¸ªå…³äº ipvs issue <a class=link href=https://github.com/kubernetes/kubernetes/issues/81775 target=_blank rel=noopener>#81775</a>ï¼Œä¸»è¦æ˜¯è®²ä¸€ä¸ªå•ä¸ªå®¢æˆ·ç«¯å‘æŸä¸ª vip å‘é€è¯·æ±‚æ—¶ï¼Œå®¹å™¨é”€æ¯è¿‡ç¨‹ä¸­ä¼šå‡ºç°å¤§é‡çš„è¯·æ±‚é”™è¯¯ã€‚å…¶ä¸­æåˆ°äº†ä¸€ä¸ªå…³äº ipvs å†…æ ¸å‚æ•° net.ipv4.vs.conn_reuse_modeï¼Œè¯¥å‚æ•°ç”¨æ¥å¼€å¯å¯¹ ipvs connect ç«¯å£é‡ç”¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>conn_reuse_mode - INTEGER
</span></span><span class=line><span class=cl>    1 - default
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    Controls how ipvs will deal with connections that are detected
</span></span><span class=line><span class=cl>    port reuse. It is a bitmap, with the values being:
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    0: disable any special handling on port reuse. The new
</span></span><span class=line><span class=cl>    connection will be delivered to the same real server that was
</span></span><span class=line><span class=cl>    servicing the previous connection. This will effectively
</span></span><span class=line><span class=cl>    disable expire_nodest_conn.
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    bit 1: enable rescheduling of new connections when it is safe.
</span></span><span class=line><span class=cl>    That is, whenever expire_nodest_conn and for TCP sockets, when
</span></span><span class=line><span class=cl>    the connection is in TIME_WAIT state (which is only possible if
</span></span><span class=line><span class=cl>    you use NAT mode).
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    bit 2: it is bit 1 plus, for TCP connections, when connections
</span></span><span class=line><span class=cl>    are in FIN_WAIT state, as this is the last state seen by load
</span></span><span class=line><span class=cl>    balancer in Direct Routing mode. This bit helps on adding new
</span></span><span class=line><span class=cl>    real servers to a very busy cluster.
</span></span></code></pre></td></tr></table></div></div><ul><li>net.ipv4.vs.conn_reuse_mode=0æ—¶ï¼Œipvsä¸ä¼šå¯¹æ–°è¿æ¥è¿›è¡Œé‡æ–°è´Ÿè½½ï¼Œè€Œæ˜¯å¤ç”¨ä¹‹å‰çš„è´Ÿè½½ç»“æœï¼Œå°†æ–°è¿æ¥è½¬å‘åˆ°åŸæ¥çš„rsä¸Šï¼›</li><li>net.ipv4.vs.conn_reuse_mode=1æ—¶ï¼Œipvsåˆ™ä¼šå¯¹æ–°è¿æ¥è¿›è¡Œé‡æ–°è°ƒåº¦ã€‚</li></ul><p>æŸ¥çœ‹å‹æµ‹çš„èŠ‚ç‚¹å†…æ ¸å‚æ•°ï¼Œå‘ç° net.ipv4.vs.conn_reuse_mode å€¼ä¸º 1ã€‚ç„¶åï¼Œæˆ‘ä»¬ä¿®æ”¹å†…æ ¸å‚æ•°ï¼š net.ipv4.vs.conn_reuse_mode=0ï¼Œå†è¿›è¡Œå‹æµ‹ï¼ŒQPS ç¨³å®šåˆ°äº† 2000 å·¦å³ã€‚è¯´æ˜é—®é¢˜å°±æ˜¯å’Œ ipvs è¿™ä¸ªå‚æ•°æœ‰å…³ã€‚</p><p>ç›¸å…³çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªå†…æ ¸å‚æ•°<code>net.ipv4.vs.expire_nodest_conn</code>ï¼Œç”¨äºæ§åˆ¶è¿æ¥çš„rsä¸å¯ç”¨æ—¶çš„å¤„ç†ã€‚åœ¨å¼€å¯æ—¶ï¼Œå¦‚æœåç«¯rsä¸å¯ç”¨ï¼Œä¼šç«‹å³ç»“æŸæ‰è¯¥è¿æ¥ï¼Œä½¿å®¢æˆ·ç«¯é‡æ–°å‘èµ·æ–°çš„è¿æ¥è¯·æ±‚ï¼›å¦åˆ™å°†æ•°æ®åŒ…<strong>silently drop</strong>ï¼Œä¹Ÿå°±æ˜¯DROPæ‰æ•°æ®åŒ…ä½†ä¸ç»“æŸè¿æ¥ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„é‡è¯•ã€‚å†…æ ¸ä¸­å…³äº<strong>destination ä¸å¯ç”¨</strong>çš„åˆ¤æ–­ï¼Œæ˜¯åœ¨ipvsæ‰§è¡Œåˆ é™¤<code>vs</code>ï¼ˆåœ¨<code>__ip_vs_del_service()</code>ä¸­å®ç°ï¼‰æˆ–åˆ é™¤<code>rs</code>ï¼ˆåœ¨<code>ip_vs_del_dest()</code>ä¸­å®ç°ï¼‰æ—¶ï¼Œä¼šè°ƒç”¨<code>__ip_vs_unlink_dest()</code>æ–¹æ³•ï¼Œå°†ç›¸åº”çš„destinationç½®ä¸ºä¸å¯ç”¨ã€‚</p><h2 id=è¿›ä¸€æ­¥æ·±æŒ–>è¿›ä¸€æ­¥æ·±æŒ–</h2><p>è™½ç„¶ï¼Œä¿®æ”¹å†…æ ¸å QPS ç”± 120+ æå‡åˆ° 2000 å·²ç»æ»¡è¶³ä¸šåŠ¡æ–¹çš„è¦æ±‚ã€‚ä½†æ˜¯è¿˜æœ‰ä¸€äº›ç–‘æƒ‘æ²¡æœ‰è§£å†³ï¼š</p><ol><li>ä¸ºä»€ä¹ˆå†…æ ¸å‚æ•°è®¾ç½®ä¸º net.ipv4.vs.conn_reuse_mode=1 æ—¶ï¼Œå¯¼è‡´ QPS é™ä½åˆ°äº† 200ï¼Ÿ</li><li>å†…æ ¸å‚æ•°ä¿®æ”¹ä¸º net.ipv4.vs.conn_reuse_mode=0 æ—¶ï¼Œä¼šå¯¼è‡´å“ªäº›é—®é¢˜ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆ docker run è¿è¡Œçš„å®¹å™¨ QPS èƒ½è¾¾åˆ° 4000 ï¼Ÿ</li></ol><p>å¸¦ç€è¿™äº›ç–‘æƒ‘ï¼Œæˆ‘ä»¬åšè¿›ä¸€æ­¥ç ”ç©¶ã€‚</p><h3 id=netipv4vsconn_reuse_mode-å¼€å¯å’Œå…³é—­å½±å“>net.ipv4.vs.conn_reuse_mode å¼€å¯å’Œå…³é—­å½±å“</h3><p>ipvs ä¼šå°†è¯·æ±‚ vs çš„è¯·æ±‚è½¬å‘åˆ° rs éœ€è¦ä½¿ç”¨ conntrack è¡¨è®°å½•æ¯ä¸€ä¸ªè¿æ¥çš„å››å…ƒç»„ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬å‹æµ‹è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æ¯ä¸€æ¡è¿æ¥éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼š</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-5.png width=2878 height=320 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-5_hu9d9917c040d32514e300702a2d20da9f_155101_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-5_hu9d9917c040d32514e300702a2d20da9f_155101_1024x0_resize_box_3.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=899 data-flex-basis=2158px></p><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¤¾åŒº 2018 å¹´åœ¨ <a class=link href=https://github.com/kubernetes/kubernetes/issues/70747 target=_blank rel=noopener>#70747</a> issue ä¸­è¿›è¡Œäº†è®¨è®ºå’Œä¿®å¤ã€‚å…¶ä¸­ comment ä¸­æœ‰æåˆ°ä¸€ä¸ª <a class=link href="https://marc.info/?l=linux-virtual-server&m=151706660530133&w=2" target=_blank rel=noopener>linux kernel çš„è®¨è®º</a>ã€‚åœ¨æœªå¼€å¯ç«¯å£å¤ç”¨æ—¶ï¼Œå¦‚æœåŒ¹é…åˆ°æ–°è¯·æ±‚å››å…ƒç»„å·²ç»å­˜åœ¨äº conntrack è¡¨ä¸­ï¼Œä¼šç›´æ¥å°†åŒ…ä¸¢å¼ƒï¼ˆNF_DROPï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// net/netfilter/ipvs/ip_vs_core.c
</span></span><span class=line><span class=cl>static unsigned int
</span></span><span class=line><span class=cl>ip_vs_in(struct netns_ipvs *ipvs, unsigned int hooknum, struct sk_buff *skb, int af)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>... ....
</span></span><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>* Check if the packet belongs to an existing connection entry
</span></span><span class=line><span class=cl>*/
</span></span><span class=line><span class=cl>cp = pp-&gt;conn_in_get(ipvs, af, skb, &amp;iph);  //åˆ¤æ–­æ˜¯å¦å±äºæŸä¸ªå·²æœ‰çš„connection
</span></span><span class=line><span class=cl>conn_reuse_mode = sysctl_conn_reuse_mode(ipvs);
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>//å½“conn_reuse_modeå¼€å¯ï¼ŒåŒæ—¶å‡ºç°ç«¯å£å¤ç”¨ï¼ˆä¾‹å¦‚æ”¶åˆ°TCPçš„SYNåŒ…ï¼Œå¹¶ä¸”ä¹Ÿå±äºå·²æœ‰çš„ connectionï¼‰ï¼Œè¿›è¡Œå¤„ç†
</span></span><span class=line><span class=cl>if (conn_reuse_mode &amp;&amp; !iph.fragoffs &amp;&amp; is_new_conn(skb, &amp;iph) &amp;&amp; cp) {
</span></span><span class=line><span class=cl>    bool uses_ct = false, resched = false;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    //å¦‚æœå¼€å¯äº†expire_nodest_connã€ç›®æ ‡rsçš„weightä¸º0
</span></span><span class=line><span class=cl>    if (unlikely(sysctl_expire_nodest_conn(ipvs)) &amp;&amp; cp-&gt;dest &amp;&amp;
</span></span><span class=line><span class=cl>       unlikely(!atomic_read(&amp;cp-&gt;dest-&gt;weight))) {
</span></span><span class=line><span class=cl>        resched = true;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        //æŸ¥è¯¢æ˜¯å¦ç”¨åˆ°äº†conntrack
</span></span><span class=line><span class=cl>        uses_ct = ip_vs_conn_uses_conntrack(cp, skb);
</span></span><span class=line><span class=cl>    } else if (is_new_conn_expected(cp, conn_reuse_mode)) {
</span></span><span class=line><span class=cl>        //è¿æ¥æ˜¯ expected çš„æƒ…å†µï¼Œæ¯”å¦‚ FTP
</span></span><span class=line><span class=cl>        uses_ct = ip_vs_conn_uses_conntrack(cp, skb);
</span></span><span class=line><span class=cl>        if (!atomic_read(&amp;cp-&gt;n_control)) {
</span></span><span class=line><span class=cl>        		resched = true;
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            /* Do not reschedule controlling connection
</span></span><span class=line><span class=cl>            * that uses conntrack while it is still
</span></span><span class=line><span class=cl>            * referenced by controlled connection(s).
</span></span><span class=line><span class=cl>            */
</span></span><span class=line><span class=cl>            resched = !uses_ct;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    //å¦‚æœexpire_nodest_connæœªå¼€å¯ï¼Œå¹¶ä¸”ä¹ŸéæœŸæœ›è¿æ¥ï¼Œå®é™…ä¸Šç›´æ¥è·³å‡ºäº†
</span></span><span class=line><span class=cl>    if (resched) {
</span></span><span class=line><span class=cl>        if (!atomic_read(&amp;cp-&gt;n_control))
</span></span><span class=line><span class=cl>            ip_vs_conn_expire_now(cp);
</span></span><span class=line><span class=cl>            __ip_vs_conn_put(cp);
</span></span><span class=line><span class=cl>            //å½“å¼€å¯äº†net.ipv4.vs.conntrackï¼ŒSYNæ•°æ®åŒ…ä¼šç›´æ¥ä¸¢å¼ƒï¼Œç­‰å¾…å®¢æˆ·ç«¯é‡æ–°å‘é€SYN
</span></span><span class=line><span class=cl>            if (uses_ct)
</span></span><span class=line><span class=cl>            		return NF_DROP;
</span></span><span class=line><span class=cl>            //æœªå¼€å¯conntrackæ—¶ï¼Œä¼šè¿›å…¥ä¸‹é¢ip_vs_try_to_scheduleçš„æµç¨‹
</span></span><span class=line><span class=cl>            cp = NULL;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>.... ...
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>TCP è¯·æ±‚å‘é€ç¬¬ä¸€ä¸ª SYN åŒ…è¢«ä¸¢å¼ƒåï¼Œéœ€è¦ç­‰å¾…ä¸€ä¸ª MSL ï¼ˆ60sï¼‰ï¼Œå®¢æˆ·ç«¯ä¼šé‡æ–°å‘é€ SYNã€‚åœ¨é«˜å¹¶å‘æƒ…å†µï¼Œç”±äºä¼šå¤§é‡æ–°å»ºè¿æ¥ï¼Œä¼šå¯¼è‡´å‡ºç°è¾ƒå¤šçš„ç«¯å£é‡ç”¨æƒ…å†µï¼Œå°±å¯¼è‡´è¿æ¥ç­‰å¾… >=1s è¿›è¡Œé‡æ–°å‘é€æ¡æ‰‹åŒ…ã€‚æ‰€ä»¥ï¼Œåœ¨ä¸Šé¢çš„å‹æµ‹å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œconnect é˜¶æ®µæœ€å¤§ä¼šè¾¾åˆ°å‡ ç§’é’Ÿã€‚kubernetes åœ¨1.13 ç‰ˆæœ¬å¼€å§‹ï¼Œå¯¹è¯¥é—®é¢˜è¿›è¡Œäº†ä¼˜åŒ–ï¼Œkube-proxy é»˜è®¤ä¼šä¿®æ”¹å†…æ ¸å‚æ•° net.ipv4.vs.conn_reuse_mode=0 ã€‚</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-6.png width=1422 height=278 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-6_hu3c12d5b6d02bbbce91d9b22ae95f064a_48097_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-6_hu3c12d5b6d02bbbce91d9b22ae95f064a_48097_1024x0_resize_box_3.png 1024w" loading=lazy alt=img class=gallery-image data-flex-grow=511 data-flex-basis=1227px></p><p>æ—¢ç„¶ä» 1.13 å¼€å§‹ä¿®æ”¹äº†é»˜è®¤å‚æ•°ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸º net.ipv4.vs.conn_reuse_mode=1 å‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬å‡ºç°é—®é¢˜çš„ç¯å¢ƒ kubernetes ç‰ˆæœ¬ä¸º 1.19.12ï¼Œos 3.10.0ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯¹ 1.19.12 k8s ä»£ç è¿›è¡Œ review å‘ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>connReuseMinSupportedKernelVersion</span> <span class=p>=</span> <span class=s>&#34;4.1&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>kernelVersion</span><span class=p>.</span><span class=nf>LessThan</span><span class=p>(</span><span class=nx>version</span><span class=p>.</span><span class=nf>MustParseGeneric</span><span class=p>(</span><span class=nx>connReuseMinSupportedKernelVersion</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;can&#39;t set sysctl %s, kernel version must be at least %s&#34;</span><span class=p>,</span> <span class=nx>sysctlConnReuse</span><span class=p>,</span> <span class=nx>connReuseMinSupportedKernelVersion</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Set the connection reuse mode
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nf>EnsureSysctl</span><span class=p>(</span><span class=nx>sysctl</span><span class=p>,</span> <span class=nx>sysctlConnReuse</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ <a class=link href=https://github.com/kubernetes/kubernetes/pull/82066 target=_blank rel=noopener>pr#82066</a> ä¸­æåˆ°ï¼Œç”±äºå‡ºç° 3.10 ç‰ˆæœ¬å†…æ ¸ä¸­éƒ¨ç½² kube-proxy å¼€å¯ ipvs æ¨¡å¼åæ— æ³•å¯åŠ¨ã€‚ç¤¾åŒºå¢åŠ äº†å†…æ ¸ç‰ˆæœ¬çš„ checkï¼Œ1.19.0 å¼€å§‹å¦‚æœå†…æ ¸ç‰ˆæœ¬ &lt;4.1 åˆ™ä¸ä¼šä¿®æ”¹ net.ipv4.vs.conn_reuse_mode å†…æ ¸å‚æ•°ã€‚</p><p>å¦å¤–ï¼Œä¸Šé¢ issue ä¸­ä¹Ÿæåˆ°äº†ï¼Œä¸»è¦å½±å“æ˜¯åœ¨å¤§é‡çŸ­è¿æ¥æ—¶ä¼šå‡ºç°ç«¯å£é‡ç”¨çš„æƒ…å†µã€‚é‚£å¦‚æœæˆ‘ä»¬å°†ä¸šåŠ¡æ¶æ„æ”¹æˆé•¿è¿æ¥æ˜¯å¦å°±å¯ä»¥è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p><p></p><p>æˆ‘ä»¬åç«¯éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ http server è¿›è¡Œå‹æµ‹å¯ä»¥å‘ç°ï¼Œä½¿ç”¨é•¿è¿æ¥çš„æœåŠ¡å³ä¾¿å…³é—­ç«¯å£å¤ç”¨ QPS æ˜æ˜¾å¥½ä¸ä¼˜åŒ–å†…æ ¸çš„åœºæ™¯ã€‚</p><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¼€å¯ net.ipv4.vs.conn_reuse_mode å‚æ•°åï¼Œç«¯å£é‡ç”¨å¯¼è‡´çš„é—®é¢˜ã€‚æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æåˆ°è¿‡ç¤¾åŒºçš„ä¸€ä¸ª issue <a class=link href=https://github.com/kubernetes/kubernetes/issues/81775 target=_blank rel=noopener>#81775</a>ã€‚å½“å¼€å¯ç«¯å£é‡ç”¨ï¼Œå•ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨ vip å‘é€å¤§é‡è¯·æ±‚ï¼Œå¦‚æœæŸä¸ª pod é”€æ¯ä¼šå‡ºç° no route to host æŠ¥é”™ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08:50:10 E http_client.go:558&gt; Unable to connect to 10.86.6.96:80 : dial tcp 10.86.6.96:80: connect: no route to host 08:50:11 E http_client.go:558&gt; Unable to connect to 10.86.6.96:80 : dial tcp 10.86.6.96:80: connect: no route to host 08:50:12 E http_client.go:558&gt; Unable to connect to 10.86.6.96:80 : dial tcp 10.86.6.96:80: connect: no route to host 08:50:13 E http_client.go:558&gt; Unable to connect to 10.86.6.96:80 : dial tcp 10.86.6.96:80: connect: no route to host
</span></span></code></pre></td></tr></table></div></div><p>issue ä¸­è¿›è¡Œäº†å¤§é‡è®¨è®ºï¼Œæˆ‘åœ¨è¿™é‡Œåªç®€å•åˆ†æä¸€ä¸‹å‡ºç°è¯¥é—®é¢˜çš„åŸå› ã€‚</p><p>åœ¨ Kubernetes 1.13 ä¹‹å‰ï¼Œkube-proxy ipvs æ¨¡å¼å¹¶ä¸æ”¯æŒä¼˜é›…åˆ é™¤ï¼Œå½“ Endpoint è¢«åˆ é™¤æ—¶ï¼Œkube-proxy ä¼šç›´æ¥ç§»é™¤æ‰ ipvs ä¸­å¯¹åº”çš„ rsï¼Œè¿™æ ·ä¼šå¯¼è‡´åç»­çš„æ•°æ®åŒ…è¢«ä¸¢æ‰ã€‚</p><p>åœ¨ 1.13 ç‰ˆæœ¬åï¼ŒKubernetes æ·»åŠ äº†<strong>IPVS ä¼˜é›…åˆ é™¤</strong>çš„é€»è¾‘ï¼š</p><ul><li>å½“ Pod è¢«åˆ é™¤æ—¶ï¼Œkube-proxy ä¼šå…ˆå°† rs çš„<code>weight</code>ç½®ä¸º 0ï¼Œä»¥é˜²æ­¢æ–°è¿æ¥çš„è¯·æ±‚å‘é€åˆ°æ­¤ rsï¼Œç”±äºä¸å†ç›´æ¥åˆ é™¤ rsï¼Œæ—§è¿æ¥ä»èƒ½ä¸ rs æ­£å¸¸é€šä¿¡ï¼›</li><li>å½“ rs çš„<code>ActiveConn </code>æ•°é‡ä¸º 0ï¼ˆç°åœ¨å·²æ”¹ä¸º<code>ActiveConn+InactiveConn==0</code>)ï¼Œå³ä¸å†æœ‰è¿æ¥è½¬å‘åˆ°æ­¤ rs æ—¶ï¼Œæ­¤ rs æ‰ä¼šçœŸæ­£è¢«ç§»é™¤ã€‚</li></ul><p>ä¸Šé¢æœ‰æè¿‡ InactiveConn æ˜¯å¤„äº TIME_WAIT çš„è¿æ¥ï¼Œé‚£æ¯ä¸ªå¤„äº InactiveConn çš„è¿æ¥å¤šä¹…ä¼šè¿‡æœŸå‘¢ï¼Œé»˜è®¤æ˜¯120sï¼Œé€šè¿‡ ipvsadm -L &ndash;timeout å¯ä»¥çœ‹åˆ°é»˜è®¤å€¼ï¼š</p><p><img src=/blog/p/ipvs-caused-problem/img/ipvs-analyze-9.png width=2662 height=496 srcset="/blog/p/ipvs-caused-problem/img/ipvs-analyze-9_hu674ae24dcc1265d427fa4e80126db3d8_437372_480x0_resize_box_3.png 480w, /blog/p/ipvs-caused-problem/img/ipvs-analyze-9_hu674ae24dcc1265d427fa4e80126db3d8_437372_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=536 data-flex-basis=1288px></p><p>æ­£å¸¸æƒ…å†µ 120s å°±å°†è¿æ¥åœ¨ conntrack è¡¨ä¸­åˆ é™¤ã€‚ä½†å½“å¼€å¯ç«¯å£é‡ç”¨åï¼Œæƒé‡ä¿®æ”¹ä¸º 0 çš„ rs å¦‚æœå†æ¬¡è¢«å¤ç”¨ï¼Œå¯¹äºç«¯å£å¤ç”¨çš„è¿æ¥ï¼Œipvs ä¸ä¼šä¸»åŠ¨è¿›è¡Œæ–°çš„è°ƒåº¦ï¼ˆè°ƒç”¨<code>ip_vs_try_to_schedule</code>æ–¹æ³•ï¼‰ï¼›åŒæ—¶ï¼Œåªæ˜¯å°†<code>weight</code>ç½®ä¸º 0ï¼Œä¹Ÿå¹¶ä¸ä¼šè§¦å‘ç”±<code>expire_nodest_conn </code>æ§åˆ¶çš„ç»“æŸè¿æ¥æˆ– DROP æ“ä½œï¼Œå°±è¿™æ ·ï¼Œæ–°è¿æ¥çš„æ•°æ®åŒ…å½“åšä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿä¸€æ ·ï¼Œå‘é€ç»™äº†æ­£åœ¨åˆ é™¤çš„ Podã€‚è€Œè¿™æ ·çš„ä¸€ä¸ªè¿æ¥è¢« ipvs è®¤ä¸ºæ˜¯æ–°çš„è¯·æ±‚ï¼Œä¼šé‡ç½® ipvs timerï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹åº”çš„è¿™ä¸€ä¸ªè¿æ¥éœ€è¦é‡æ–°ç­‰å¾… 120s æ‰ä¼šè¢«åˆ é™¤ã€‚ä¸Šé¢æåˆ°è¿‡ï¼Œkube-proxy åœ¨ ActiveConn+InactiveConn==0 æ—¶æ‰ä¼šåˆ é™¤ rsï¼Œè¿™æ ·ä¸€æ¥ï¼Œåªè¦ä¸æ–­çš„æœ‰ç«¯å£å¤ç”¨çš„è¿æ¥è¯·æ±‚å‘æ¥ï¼Œrs å°±ä¸ä¼šè¢« kube-proxy åˆ é™¤ï¼Œä¸Šé¢æåˆ°çš„ä¼˜é›…åˆ é™¤æ˜¯æ— æ³•å®ç°ã€‚</p><p>å½“åç«¯åº”ç”¨è¿›ç¨‹é€€å‡ºåï¼Œåé¢ç«¯å£å¤ç”¨çš„è¯·æ±‚ï¼Œä¼šå‘é€åˆ°å·²ç»è¢«å®Œå…¨åˆ é™¤çš„å®¹å™¨ ip ä¸Šï¼Œå°±ä¼šå‡ºç°ä¸Šé¢çš„ connect: no route to host æŠ¥é”™ã€‚å¹¶ä¸”è¿™ä¸ªæŠ¥é”™æ ¹æ® ipvs å¦ä¸€ä¸ªå‚æ•°é…ç½®æœ‰å…³ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>ip_vs_in</span><span class=p>(</span><span class=k>struct</span> <span class=n>netns_ipvs</span> <span class=o>*</span><span class=n>ipvs</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>hooknum</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sk_buff</span> <span class=o>*</span><span class=n>skb</span><span class=p>,</span> <span class=kt>int</span> <span class=n>af</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>...</span> <span class=p>....</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Check if the packet belongs to an existing connection entry
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>cp</span> <span class=o>=</span> <span class=n>pp</span><span class=o>-&gt;</span><span class=nf>conn_in_get</span><span class=p>(</span><span class=n>ipvs</span><span class=p>,</span> <span class=n>af</span><span class=p>,</span> <span class=n>skb</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>iph</span><span class=p>);</span>  <span class=c1>//åˆ¤æ–­æ˜¯å¦å±äºæŸä¸ªå·²æœ‰çš„connection
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl><span class=n>conn_reuse_mode</span> <span class=o>=</span> <span class=nf>sysctl_conn_reuse_mode</span><span class=p>(</span><span class=n>ipvs</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>//å½“conn_reuse_modeå¼€å¯ï¼ŒåŒæ—¶å‡ºç°ç«¯å£å¤ç”¨ï¼ˆä¾‹å¦‚æ”¶åˆ°TCPçš„SYNåŒ…ï¼Œå¹¶ä¸”ä¹Ÿå±äºå·²æœ‰çš„ connectionï¼‰ï¼Œè¿›è¡Œå¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>conn_reuse_mode</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>iph</span><span class=p>.</span><span class=n>fragoffs</span> <span class=o>&amp;&amp;</span> <span class=nf>is_new_conn</span><span class=p>(</span><span class=n>skb</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>iph</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>cp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=kt>bool</span> <span class=n>uses_ct</span> <span class=o>=</span> <span class=nb>false</span><span class=p>,</span> <span class=n>resched</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=c1>//å¦‚æœå¼€å¯äº†expire_nodest_connã€ç›®æ ‡rsçš„weightä¸º0
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>if</span> <span class=p>(</span><span class=nf>unlikely</span><span class=p>(</span><span class=nf>sysctl_expire_nodest_conn</span><span class=p>(</span><span class=n>ipvs</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=n>cp</span><span class=o>-&gt;</span><span class=n>dest</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>     <span class=nf>unlikely</span><span class=p>(</span><span class=o>!</span><span class=nf>atomic_read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cp</span><span class=o>-&gt;</span><span class=n>dest</span><span class=o>-&gt;</span><span class=n>weight</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>resched</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>  <span class=c1>//æŸ¥è¯¢æ˜¯å¦ç”¨åˆ°äº†conntrack
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uses_ct</span> <span class=o>=</span> <span class=nf>ip_vs_conn_uses_conntrack</span><span class=p>(</span><span class=n>cp</span><span class=p>,</span> <span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nf>is_new_conn_expected</span><span class=p>(</span><span class=n>cp</span><span class=p>,</span> <span class=n>conn_reuse_mode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//è¿æ¥æ˜¯expectedçš„æƒ…å†µï¼Œæ¯”å¦‚FTP
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uses_ct</span> <span class=o>=</span> <span class=nf>ip_vs_conn_uses_conntrack</span><span class=p>(</span><span class=n>cp</span><span class=p>,</span> <span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>atomic_read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cp</span><span class=o>-&gt;</span><span class=n>n_control</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>resched</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=cm>/* Do not reschedule controlling connection
</span></span></span><span class=line><span class=cl><span class=cm>    * that uses conntrack while it is still
</span></span></span><span class=line><span class=cl><span class=cm>    * referenced by controlled connection(s).
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>   <span class=n>resched</span> <span class=o>=</span> <span class=o>!</span><span class=n>uses_ct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=c1>//å¦‚æœexpire_nodest_connæœªå¼€å¯ï¼Œå¹¶ä¸”ä¹ŸéæœŸæœ›è¿æ¥ï¼Œå®é™…ä¸Šç›´æ¥è·³å‡ºäº†
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>if</span> <span class=p>(</span><span class=n>resched</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>atomic_read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cp</span><span class=o>-&gt;</span><span class=n>n_control</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=nf>ip_vs_conn_expire_now</span><span class=p>(</span><span class=n>cp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__ip_vs_conn_put</span><span class=p>(</span><span class=n>cp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>//å½“å¼€å¯äº†net.ipv4.vs.conntrackï¼ŒSYNæ•°æ®åŒ…ä¼šç›´æ¥ä¸¢å¼ƒï¼Œç­‰å¾…å®¢æˆ·ç«¯é‡æ–°å‘é€SYN
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>uses_ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>NF_DROP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>//æœªå¼€å¯conntrackæ—¶ï¼Œä¼šè¿›å…¥ä¸‹é¢ip_vs_try_to_scheduleçš„æµç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cp</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=p>....</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>expire_nodest_conn=0 æ—¶ï¼Œå½“åç«¯ rs ä¸å¯è¾¾æ—¶ï¼Œipvs ä¼šç›´æ¥å°†æ•°æ®åŒ…ä¸¢å¼ƒï¼›
</span></span></code></pre></td></tr></table></div></div></li><li><p>expire_nodest_conn=1 æ—¶ï¼Œå½“åç«¯ rs ä¸å¯è¾¾ï¼Œç«‹å³ä¼šè¿”å›ä¸€ä¸ªæŠ¥é”™ç»™å®¢æˆ·ç«¯ã€‚</p></li></ul><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œåªåœ¨ kubernetes ä¸Šå¹¶ä¸èƒ½å®Œç¾çš„è§£å†³ï¼Œä¾‹å¦‚ï¼škube-router ä¸­å¢åŠ äº†ä¼˜é›…ä¸‹çº¿ï¼Œä¼šç­‰å¾… Pod é…ç½®çš„ TerminationGracePeriodSeconds åè¿›è¡Œåˆ é™¤ rsï¼Œè¿™æ ·åªèƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…è¯¥é—®é¢˜ã€‚</p><h3 id=å•æ ¸æ€§èƒ½æ›´ä¼˜>å•æ ¸æ€§èƒ½æ›´ä¼˜ï¼Ÿ</h3><p>ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨ docker run åœ¨çº¿æ¨ç†ä¸šåŠ¡å¯ä»¥è¾¾åˆ° 4000 QPSï¼Œè€Œ Kubernetes å®¹å™¨é€šè¿‡å†…æ ¸ä¼˜åŒ–ååªèƒ½è¾¾åˆ° 2000ï¼Ÿ</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆå’Œä¸šåŠ¡æ–¹åŒå­¦è¿›è¡Œç¡®è®¤å¯åŠ¨ docker çš„å‚æ•°ï¼Œç»è¿‡ç¡®è®¤å‘ç°ä¸šåŠ¡æ–¹åŒå­¦è¯¯å°† &ndash;cpuset-cpus å½“ä½œé™åˆ¶ cpu ä½¿ç”¨äº†ï¼Œå…¶å¯åŠ¨å‚æ•°å‘½ä»¤ä¸ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker run --cpuset-cpus 4 xxxx
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå¯åŠ¨å‘½ä»¤ï¼Œæœ€ç»ˆåˆ›å»ºçš„å®¹å™¨å…¶å®åªä½¿ç”¨äº†ä¸€ä¸ªæ ¸ï¼Œå¹¶ä¸”å°†åº”ç”¨è¿›ç¨‹ç»‘å®šåˆ°äº†ç¬¬ 4 ä¸ª cpu ä¸Šã€‚ç„¶åï¼Œé€šè¿‡ä¿®æ”¹å‘½ä»¤æ”¹æˆéç»‘æ ¸ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤å¯åŠ¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker run --cpu-quota 400000 xxxx
</span></span></code></pre></td></tr></table></div></div><p>å†è¿›è¡Œå‹æµ‹ QPS é™ä½åˆ°äº† 2500ï¼Œå·²ç»å’Œ kubernetes åˆ›å»ºçš„å®¹å™¨éå¸¸æ¥è¿‘ã€‚ç”±äºä½¿ç”¨ vip ä¼šç»è¿‡ ipvs è¿›è¡Œæ•°æ®åŒ…çš„å¤„ç†ï¼Œä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—ï¼Œè¿™ä¸ªç»“æœä¹Ÿæ¯”è¾ƒåˆç†ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆç»‘æ ¸æƒ…å†µåˆ†é…1ä¸ª cpu çš„åº”ç”¨æ€§èƒ½ä¼šæ¯”æ²¡æœ‰ç»‘æ ¸ cpu ä¼šå¥½ä¸€å€å‘¢ï¼Ÿ</p><p>çŒœæµ‹å’Œä¸šåŠ¡æœåŠ¡é€»è¾‘æœ‰å…³ï¼Œåé¢è¿˜è¦å†è¿›è¡ŒéªŒè¯ã€‚</p><p>æ²Ÿé€šä¸‹æ¥ç¡®è®¤è¿™ä¸ªæœåŠ¡ä¸šåŠ¡åŠŸèƒ½æ˜¯ï¼šé¦–å…ˆåšå°‘é‡çš„æ•°å­¦è¿ç®—ï¼Œç„¶åå†ä¸é€šè¿‡ grpc è°ƒç”¨åç«¯æœåŠ¡æ‹¿åˆ°çš„ç»“æœè¿›è¡Œè®¡ç®—ï¼Œå°†æœ€ç»ˆçš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·çš„è¯ï¼Œè¿™ä¸ªä¸šåŠ¡åº”è¯¥ç®—æ˜¯ä¸€ä¸ª io å¯†é›†å‹åº”ç”¨ï¼Œå¹¶ä¸éœ€è¦è¾ƒé«˜çš„ cpu çš„ï¼Œ ç»‘æ ¸åèƒ½å¤Ÿå‡å°‘ cpu ä¹‹é—´é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¸¦æ¥æ›´å¥½çš„æ•ˆæœã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>é€šè¿‡ä¿®æ”¹ ipvs å†…æ ¸å‚æ•°ï¼ŒååŠ©è”é‚¦åŒå­¦è§£å†³äº†é‡åˆ°çš„ååç‡é—®é¢˜ï¼Œå°† QPS ä» 200 æå‡åˆ°äº† 2000+ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯æ­¢æ­¥äºè§£å†³é—®é¢˜ï¼Œå¯¹é—®é¢˜è¿‡ç¨‹ä¸­é‡åˆ°çš„ç–‘æƒ‘è¿›ä¸€æ­¥ç ”ç©¶ï¼Œå¸®åŠ©æˆ‘ä»¬èƒ½å¤Ÿå¯¹ kubernetes ç³»ç»Ÿæœ‰å…¨é¢çš„æŠŠæ§ã€‚</p><ul><li>åœ¨ 1.19.0 ç‰ˆæœ¬å¼€å§‹ kubernetes å¯¹ ipvs é»˜è®¤å†…æ ¸å‚æ•°è¿›è¡Œäº†æ”¹è¿›ï¼Œå½“å†…æ ¸ç‰ˆæœ¬ &lt;4.1 æ—¶ï¼Œkube-proxy ä¸ä¼šä¿®æ”¹ ipvs å†…æ ¸å‚æ•° net.ipv4.vs.conn_reuse_modeã€‚</li><li>é€šè¿‡ä¿®æ”¹å†…æ ¸å‚æ•°æé«˜äº†ååç‡ï¼Œä½†åŒæ—¶å¸¦æ¥äº†ä¼˜é›…ä¸‹çº¿çš„é—®é¢˜ï¼Œåœ¨ 5.9 å¼€å§‹ linux å†…æ ¸å±‚é¢å·²æœ‰è§£å†³ã€‚å¦å¤–ï¼Œæˆ‘ä»¬é’ˆå¯¹å¯ä»¥å¯¹ä¸šåŠ¡æ¶æ„ä¼˜åŒ–çš„åœºæ™¯ä½¿ç”¨é•¿è¿æ¥æ–¹å¼è¿›è¡Œå‹æµ‹ï¼Œèƒ½å¤Ÿæ˜¾è‘—çš„è§£å†³ååç‡é™ä½çš„é—®é¢˜ã€‚</li><li>å¯¹äº docker run åœºæ™¯ QPS æ˜¯ Kubernetes å®¹å™¨çš„ä¸¤å€é—®é¢˜ï¼Œæˆ‘ä»¬å‘ç°ä¸šåŠ¡åŒå­¦ä½¿ç”¨ docker è¿è¡Œæ—¶ä½¿ç”¨äº† &ndash;cpuset-cpus å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°†åº”ç”¨ç»‘å®šåˆ°æŸä¸€ä¸ª cpu æ ¸ä¸Šã€‚è¿™è¯´æ˜å¯¹äºæŸäº›åº”ç”¨å¹¶ä¸æ˜¯åˆ†é…çš„åº”ç”¨ cpu è¶Šå¤šï¼Œæ€§èƒ½è¶Šå¥½ã€‚</li></ul><p>ç›®å‰ï¼Œå‘ç°é—®é¢˜çš„ä¸»è¦åœºæ™¯æ˜¯åœ¨ä½¿ç”¨å®˜æ–¹é»˜è®¤ç½‘ç»œç»„ä»¶ kube-proxy å¸¦æ¥çš„é—®é¢˜ã€‚è€Œæˆ‘ä»¬ IDC å†…éƒ¨ä½¿ç”¨ kube-router ä½¿ç”¨äº†å’Œ Pod TerminationGracePeriodSeconds ä¸€è‡´çš„ç­‰å¾…æ—¶é—´æ¥ä¼˜é›…åˆ é™¤ rsã€‚</p><p>å¦å¤–ï¼Œé’ˆå¯¹ ipvs æ€§èƒ½ç¤¾åŒºä¹Ÿæœ‰ä¸€äº›ä½¿ç”¨ eBPF æ¥å®ç°çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼šCilliumã€è…¾è®¯ ipvs-ebpf ç­‰ã€‚</p><h2 id=å‚è€ƒ>å‚è€ƒ</h2><ol><li><a class=link href="https://marc.info/?l=linux-virtual-server&m=151683112005533&w=2" target=_blank rel=noopener>https://marc.info/?l=linux-virtual-server&m=151683112005533&w=2</a></li><li><a class=link href=https://github.com/kubernetes/kubernetes/issues/70747 target=_blank rel=noopener>IPVS low throughput</a></li><li><a class=link href=http://patchwork.ozlabs.org/project/netfilter-devel/patch/20200701151719.4751-1-ja@ssi.bg/ target=_blank rel=noopener>è§£å†³å…³é—­ç«¯å£å¤ç”¨å‡ºç° 1s å»¶è¿Ÿçš„ patch</a></li><li><a class=link href=http://patchwork.ozlabs.org/project/netfilter-devel/patch/20200708161638.13584-1-kim.andrewsy@gmail.com/ target=_blank rel=noopener>å¼€å¯ç«¯å£å¤ç”¨å rs ä¸‹çº¿å¯¼è‡´åç«¯ä¸å¯ç”¨é—®é¢˜</a></li><li><a class=link href=https://cloud.tencent.com/developer/article/1687922 target=_blank rel=noopener>ç»•è¿‡conntrackï¼Œä½¿ç”¨eBPFå¢å¼º IPVSä¼˜åŒ–K8sç½‘ç»œæ€§èƒ½</a></li></ol></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/how-endpoint-flush-ipvs/><div class=article-image><img src=/blog/p/how-endpoint-flush-ipvs/_huf941de4769045cdfa8c9ee7036519a2a_35369_36687b530fa140121781e790cfd060e7.jpg width=250 height=150 loading=lazy alt="Featured image of post endpoint æ›´æ–°å vip è½¬å‘å®ç°æ¢ç©¶" data-key=how-endpoint-flush-ipvs data-hash="md5-YBFrHM/IYy6aZffVHfPvwg=="></div><div class=article-details><h2 class=article-title>endpoint æ›´æ–°å vip è½¬å‘å®ç°æ¢ç©¶</h2></div></a></article><article class=has-image><a href=/blog/p/kubectl-exec-deepin/><div class=article-image><img src=/blog/p/kubectl-exec-deepin/_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_27040ddd7399aaf289c0ce70ee6592d9.jpg width=250 height=150 loading=lazy alt="Featured image of post ä» kubectl exec å¼‚å¸¸é—®é¢˜å¼€å§‹" data-key=kubectl-exec-deepin data-hash="md5-RvYejqai34/Fvx0koXxEpg=="></div><div class=article-details><h2 class=article-title>ä» kubectl exec å¼‚å¸¸é—®é¢˜å¼€å§‹</h2></div></a></article><article class=has-image><a href=/blog/p/service-cause-failure/><div class=article-image><img src=/blog/p/service-cause-failure/_hu0a3f1163de68d0b9471979ebf0ecf11e_32400_a354a9a1f5102742bceb4ec236f4ce2f.jpg width=250 height=150 loading=lazy alt="Featured image of post pod é”€æ¯è¿‡ç¨‹å¼•èµ·çŸ­æ—¶æœåŠ¡ä¸å¯ç”¨" data-key=service-cause-failure data-hash="md5-rC+UhC7sa7h6Y66uIugvQQ=="></div><div class=article-details><h2 class=article-title>pod é”€æ¯è¿‡ç¨‹å¼•èµ·çŸ­æ—¶æœåŠ¡ä¸å¯ç”¨</h2></div></a></article><article class=has-image><a href=/blog/p/pod-pending-with-enough-resources/><div class=article-image><img src=/blog/p/pod-pending-with-enough-resources/sleep-boy.ba540b47bff96318db80025530254292_hud07293a026e0ecb8feb93a2c733978af_122481_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post é›†ç¾¤èµ„æºå……è¶³æƒ…å†µ Pod å‡ºç° schedulfailed" data-key=pod-pending-with-enough-resources data-hash="md5-ulQLR7/5YxjbgAJVMCVCkg=="></div><div class=article-details><h2 class=article-title>é›†ç¾¤èµ„æºå……è¶³æƒ…å†µ Pod å‡ºç° schedulfailed</h2></div></a></article><article><a href=/blog/p/gpu-start-failure/><div class=article-details><h2 class=article-title>kubelet å¼€å¯ static å¼•å‘ gpu å®¹å™¨éƒ¨ç½²å¼‚å¸¸</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 jason's åšå®¢</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>