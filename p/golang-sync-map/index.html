<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æœ€è¿‘çœ‹åˆ°äº†ä¸€ä¸ªæ–‡ç« [1]ï¼Œå…¶ä¸­æåˆ°äº† sync.map çš„ä¸€ä¸ªå†…å­˜æ³„éœ² bug, æœ¬æ–‡å¯¹ sync.map è¿›è¡Œç ”ç©¶"><title>GO sync.map æ¢ç©¶</title><link rel=canonical href=https://jasonrd.github.io/blog/p/golang-sync-map/><link rel=stylesheet href=/blog/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="GO sync.map æ¢ç©¶"><meta property="og:description" content="æœ€è¿‘çœ‹åˆ°äº†ä¸€ä¸ªæ–‡ç« [1]ï¼Œå…¶ä¸­æåˆ°äº† sync.map çš„ä¸€ä¸ªå†…å­˜æ³„éœ² bug, æœ¬æ–‡å¯¹ sync.map è¿›è¡Œç ”ç©¶"><meta property="og:url" content="https://jasonrd.github.io/blog/p/golang-sync-map/"><meta property="og:site_name" content="jason's åšå®¢"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2021-12-17T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-17T00:00:00+00:00"><meta name=twitter:site content="@jasonxie666"><meta name=twitter:creator content="@jasonxie666"><meta name=twitter:title content="GO sync.map æ¢ç©¶"><meta name=twitter:description content="æœ€è¿‘çœ‹åˆ°äº†ä¸€ä¸ªæ–‡ç« [1]ï¼Œå…¶ä¸­æåˆ°äº† sync.map çš„ä¸€ä¸ªå†…å­˜æ³„éœ² bug, æœ¬æ–‡å¯¹ sync.map è¿›è¡Œç ”ç©¶"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/avatar_hu92a1f0f4dac05816138a9efb01424f59_787601_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>jason's åšå®¢</a></h1><h2 class=site-description>Welcom</h2></div></header><ol class=social-menu><li><a href=https://github.com/JasonRD target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/jasonxie666 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>ä¸»é¡µ</span></a></li><li><a href=/blog/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>å…³äº</span></a></li><li><a href=/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/blog/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://jasonrd.github.io/blog/en/>English</option><option value=https://jasonrd.github.io/blog/ selected>ä¸­æ–‡</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#æºç åˆ†æ>æºç åˆ†æ</a><ol><li><a href=#æ•°æ®ç»“æ„>æ•°æ®ç»“æ„</a></li><li><a href=#æ¥å£åˆ†æ>æ¥å£åˆ†æ</a><ol><li><a href=#store-é€»è¾‘>Store é€»è¾‘ï¼š</a></li><li><a href=#load-é€»è¾‘>Load é€»è¾‘</a></li><li><a href=#delete-é€»è¾‘>Delete é€»è¾‘</a></li></ol></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li><li><a href=#reference>reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/blog/categories/golang/>golang</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/golang-sync-map/>GO sync.map æ¢ç©¶</a></h2><h3 class=article-subtitle>æœ€è¿‘çœ‹åˆ°äº†ä¸€ä¸ªæ–‡ç« [1]ï¼Œå…¶ä¸­æåˆ°äº† sync.map çš„ä¸€ä¸ªå†…å­˜æ³„éœ² bug, æœ¬æ–‡å¯¹ sync.map è¿›è¡Œç ”ç©¶</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 17, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 3 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=èƒŒæ™¯>èƒŒæ™¯</h2><p>æœ€è¿‘çœ‹åˆ°äº†ä¸€ä¸ªæ–‡ç« [1]ï¼Œå…¶ä¸­æåˆ°äº† sync.map çš„ä¸€ä¸ªbugï¼Œkey å¦‚æœä½¿ç”¨è¿æ¥ï¼Œä¼šå¯¼è‡´è¿æ¥æ³„æ¼ã€‚æ–‡ä¸­æåˆ°äº†å…·ä½“åŸå› æ˜¯ sync.map å¯¹ key åˆ é™¤æ˜¯è½¯åˆ é™¤ï¼Œåªæ˜¯å°† å¯ä»¥å¯¹åº”çš„ value ç½®ä¸º nilï¼Œkey è¿˜ä¼šç»§ç»­å­˜åœ¨ã€‚</p><p>æ ¹æ®æ–‡ç« ä¸­æè¿°ï¼Œå‘ç°è‡ªå·±å¯¹ sync.Map äº†è§£ä¸å¤Ÿé€å½»ï¼Œæ‰€ä»¥å°±æ‰“ç®—è¿›è¡Œä¸€ç•ªäº†è§£ã€‚sync.Map æ˜¯ go æ ‡å‡†åº“ä¸­å®ç°çš„çº¿ç¨‹å®‰å…¨çš„ Mapï¼Œä¸»è¦é€‚ç”¨çš„åœºæ™¯ï¼š</p><blockquote><blockquote><p>The Map type is optimized for two common use cases:
(1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, or
(2) when multiple goroutines read, write, and overwrite entries for disjoint sets of keys. In these two cases, use of a Map may significantly reduce lock contention compared to a Go map paired with a separate Mutex or RWMutex.</p></blockquote></blockquote><ol><li>åŒä¸€ä¸ª key è¯»å¤šå†™å°‘ï¼›</li><li>å¹¶å‘è¯»ã€å†™ã€è¦†ç›–ä¸åŒ keyï¼›</li></ol><p>å…¶ä¸­ï¼Œsync.Map åŒ…ä¸­æåˆ°ï¼Œåœ¨è¿™ä¸¤ç§åœºæ™¯ä¸­æ€§èƒ½è¦ä¼˜äºä½¿ç”¨ Map + Mutexã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•å®ç°çš„ï¼Œä¸ºä»€ä¹ˆåœ¨è¿™ä¸¤ç§åœºæ™¯ä¸‹æ€§èƒ½æœ‰ä¼˜åŠ¿ã€‚</p><h2 id=æºç åˆ†æ>æºç åˆ†æ</h2><h3 id=æ•°æ®ç»“æ„>æ•°æ®ç»“æ„</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type Map struct {
</span></span><span class=line><span class=cl>    mu Mutex
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // åªè¯»åŒºï¼Œä¿å­˜éƒ¨åˆ†å¥å€¼å¯¹
</span></span><span class=line><span class=cl>    // ä¿®æ”¹æ—¶è¿›è¡ŒåŸå­æ€§æ›¿æ¢
</span></span><span class=line><span class=cl>    read atomic.Value
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // æ–°å†™å…¥çš„å¥å€¼å¯¹ï¼Œå…ˆä¿å­˜åˆ° dirty ä¸­
</span></span><span class=line><span class=cl>    // æ›´æ–°æˆ–è€…è¢«åˆ é™¤çš„ï¼Œdirty ä¸­ä¸ä¼šå­˜å‚¨ expunged å¥å€¼å¯¹
</span></span><span class=line><span class=cl>    dirty map[interface{}]*entry
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // è®°å½• Load å‡ºç°å¤šå°‘æ¬¡åœ¨ dirty ä¸­è¯»å–å¥å€¼å¯¹æƒ…å†µã€‚
</span></span><span class=line><span class=cl>    misses int
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// å­˜å‚¨ value çš„æŒ‡é’ˆ
</span></span><span class=line><span class=cl>// key è¢«åˆ é™¤æ—¶é€šè¿‡ CAS ä¿®æ”¹ä¸º nil æˆ– expunged
</span></span><span class=line><span class=cl>type entry struct {
</span></span><span class=line><span class=cl>    p unsafe.Pointer // *interface{}
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>type readOnly struct {
</span></span><span class=line><span class=cl>    // å­˜å‚¨çš„éƒ¨åˆ†å¥å€¼å¯¹ï¼Œåªä¼š m ä¸­å…ƒç´ 
</span></span><span class=line><span class=cl>    // ä¸ä¼šå­˜åœ¨å¹¶å‘è¯»å†™æƒ…å†µã€‚
</span></span><span class=line><span class=cl>    m       map[interface{}]*entry
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // dirty ä¸­æ˜¯å¦æœ‰ read.m ä¸­ä¸å­˜åœ¨çš„å¥å€¼å¯¹
</span></span><span class=line><span class=cl>    amended bool // true if the dirty map contains some key not in m.
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>sync.Map ä¸­ä½¿ç”¨äº†ä¸¤ä¸ª map å¯¹è±¡æ¥å°½é‡é¿å…é”ç«äº‰ï¼Œç›¸å½“äºå¢åŠ ä¸€ä¸ªç¼“å†²ã€‚å…¶ä¸­ read map ä¸­è®°å½•éƒ¨åˆ†å¥å€¼å¯¹ï¼Œdirty ä¸­ä¿å­˜æ–°å†™å…¥çš„ value å’Œ read.m ä¸­æœªè¢«æ ‡è®°ä¸º expunged æˆ– nil çš„ entryã€‚</p><h3 id=æ¥å£åˆ†æ>æ¥å£åˆ†æ</h3><p><img src=/blog/p/golang-sync-map/img/map-store.jpg width=1944 height=1380 srcset="/blog/p/golang-sync-map/img/map-store_hu2f1e02e515e351c311ec896043222feb_441700_480x0_resize_q75_box.jpg 480w, /blog/p/golang-sync-map/img/map-store_hu2f1e02e515e351c311ec896043222feb_441700_1024x0_resize_q75_box.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=140 data-flex-basis=338px></p><h4 id=store-é€»è¾‘>Store é€»è¾‘ï¼š</h4><ol><li>åˆ¤æ–­ read.m ä¸­æ˜¯å¦å­˜åœ¨keyã€‚<ul><li>å¦‚æœå­˜åœ¨è¿›è¡Œå°è¯•æ›´æ–°ï¼Œä¼šèµ·ä¸€ä¸ªå¾ªç¯ä¸åœå°è¯• CAS æ›´æ–°ï¼Œæ›´æ–°æˆåŠŸåˆ™è¿”å›ã€‚</li><li>å¦‚æœread.m ä¸­ä¸å­˜åœ¨ keyï¼Œæˆ–è€…æ›´æ–°è¿‡ç¨‹ä¸­å‘ç° key å¯¹åº” entry å·²è¢«æ ‡è®°ä¸º expungedï¼Œåˆ™è¿›è¡Œç¬¬äºŒæ­¥ï¼›</li><li>å¯ä»¥çœ‹å‡ºå¦‚æœæ›´æ–°æŸä¸ª key (å·²ç»åœ¨ read.m ä¸­ï¼Œå¹¶ä¸”æœªè¢«åˆ é™¤) ï¼Œæ›´æ–°å¹¶ä¸ä¼šåŠ é”</li></ul></li><li>åŠ é”ï¼Œå†æ¬¡åˆ¤æ–­ read.m ä¸­æ˜¯å¦å­˜åœ¨<ul><li>å¦‚æœå­˜åœ¨ï¼Œç„¶ååˆ¤æ–­ä¹‹å‰ entry æ˜¯å¦ä¸º expunged çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼ˆè¯´æ˜ dirty ä¸­ä¸å­˜åœ¨ keyï¼‰ï¼Œåˆ™æŠŠ key-entry å†™å…¥ dirty map ä¸­ï¼›ç„¶åï¼ŒåŸå­æ›´æ–° entry.p æŒ‡é’ˆã€‚</li><li>å¦åˆ™è¿›è¡Œç¬¬ä¸‰æ­¥</li></ul></li><li>dirty map ä¸­æ˜¯å¦å­˜åœ¨ keyï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥åŸå­æ›´æ–° entry.p æŒ‡é’ˆï¼›å¦åˆ™ï¼Œè¿›è¡Œç¬¬å››æ­¥ï¼›</li><li>read å’Œ dirty ä¸­éƒ½ä¸å­˜åœ¨ç›®æ ‡ keyï¼Œåˆ™æ·»åŠ åˆ° dirty ä¸­ã€‚æ·»åŠ ä¼šåšä¸€äº›æ•°æ®åŒæ­¥æ“ä½œï¼š<ul><li>å¦‚æœ read.m ä¸éœ€è¦è¿›è¡Œä¿®æ­£ï¼ˆ read.amended = falseï¼‰ï¼Œåˆ™åŒæ­¥ read.m ä¸­ä¸ºè¢«åˆ é™¤ï¼ˆenty.p!=nil or expungedï¼‰å¥å€¼å¯¹åˆ° dirty map ä¸­ã€‚å¹¶é€šè¿‡ CAS æ“ä½œæ›´æ–°read.m ä¸­è¢«åˆ é™¤çš„ entryï¼ˆenty.p = nilï¼‰æ ‡è®°ä¸º expungedã€‚</li><li>å¦åˆ™ï¼Œç›´æ¥æ·»åŠ åˆ° dirty ä¸­ã€‚</li></ul></li></ol><h4 id=load-é€»è¾‘>Load é€»è¾‘</h4><p><img src=/blog/p/golang-sync-map/img/map-load.jpg width=1748 height=1098 srcset="/blog/p/golang-sync-map/img/map-load_hu2f1e02e515e351c311ec896043222feb_291641_480x0_resize_q75_box.jpg 480w, /blog/p/golang-sync-map/img/map-load_hu2f1e02e515e351c311ec896043222feb_291641_1024x0_resize_q75_box.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=159 data-flex-basis=382px></p><ol><li>read.m ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ¤æ–­æ˜¯å¦å·²è¢«åˆ é™¤ï¼Œå¹¶è¿”å›ç›¸åº”çŠ¶æ€ï¼›å¦åˆ™ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥ï¼›</li><li>åˆ¤æ–­ read.amended çŠ¶æ€ï¼š<ul><li>å¦‚æœéœ€è¦ä¿®æ­£ï¼Œè¿›è¡ŒåŠ é”ï¼Œç„¶åå†ä¸€æ¬¡åˆ¤æ–­ read.m å’Œ read.amendedï¼Œé¿å…å¹¶å‘è¿‡ç¨‹ä¸­ read å‡ºç°æ›´æ–°ï¼›</li><li>è·å– dirty ä¸­ keyï¼Œå¹¶æ›´æ–° miss æ¬¡æ•°ï¼›å¦‚æœ miss æ¬¡æ•°è¾¾åˆ° dirty.lengthï¼Œåˆ™æ›´æ–°readï¼Œå¹¶ç½® dirty=nil;</li><li>é‡Šæ”¾é”ï¼›</li></ul></li><li>åˆ¤æ–­æ˜¯å¦å­˜åœ¨ keyï¼Œæˆ–è€…æ˜¯å¦è¢«åˆ é™¤ï¼Œè¿›è¡Œç›¸åº”è¿”å›</li></ol><h4 id=delete-é€»è¾‘>Delete é€»è¾‘</h4><p><img src=/blog/p/golang-sync-map/img/map-delete.jpg width=1006 height=1070 srcset="/blog/p/golang-sync-map/img/map-delete_hu2f1e02e515e351c311ec896043222feb_158336_480x0_resize_q75_box.jpg 480w, /blog/p/golang-sync-map/img/map-delete_hu2f1e02e515e351c311ec896043222feb_158336_1024x0_resize_q75_box.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=94 data-flex-basis=225px></p><p>åˆ é™¤å’Œ Load key é€»è¾‘ç±»ä¼¼ã€‚</p><ol><li>é¦–å…ˆï¼Œåˆ¤æ–­ read ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ ‡è®° entry.p ä¸ºnilï¼›å¦‚æœä¸å­˜åœ¨ï¼Œç»§ç»­åˆ¤æ–­ amended ï¼›</li><li>åŠ é”ï¼Œè¿›è¡ŒäºŒæ¬¡åˆ¤æ–­ï¼Œç„¶åè°ƒç”¨ delete åˆ é™¤ dirty map ä¸­ keyï¼›é‡Šæ”¾é”ï¼›</li></ol><h2 id=æ€»ç»“>æ€»ç»“</h2><ol><li>read.m ä¸­å­˜åœ¨çš„ key å¹¶éè¯»å†™ä¸ä¼šåŠ é”ï¼Œè¿›è¡ŒåŸå­æ›´æ–°ï¼›æ‰€ä»¥ï¼Œå¯¹äºåŒä¸€ä¸ª key è¿›è¡Œè¯»å†™ï¼Œå…·æœ‰è¾ƒä¼˜çš„æ€§èƒ½ï¼›</li><li>å†™å…¥æ—¶ï¼Œä¼˜å…ˆå†™å…¥ dirty mapï¼Œå¯¹äºå…¶ä»–å·²ç»å­˜åœ¨äº read.m ä¸­çš„ key è¯»å†™å¹¶æ²¡æœ‰æ€§èƒ½å½±å“ï¼›</li></ol><p>é€šè¿‡ä¸Šé¢å†™å…¥ã€åˆ é™¤ã€è·å–é€»è¾‘ï¼Œå¯ä»¥çœ‹å‡ºï¼š</p><ol><li>key å¤§éƒ¨åˆ†æ˜¯è½¯åˆ é™¤ï¼Œå³æ ‡è®° entry.p ä¸º nil æˆ– expungedã€‚åªæœ‰åœ¨<code>åˆ é™¤->æ–°å¢->è¯»å–->(missed > dirty.length)->ä¿®æ­£read.m</code>æƒ…å†µä¼šé€šè¿‡ GC è‡ªåŠ¨åˆ é™¤ keyã€‚</li><li>read.amended æ ‡ç¤ºå­˜åœ¨æŸäº› key åªå­˜åœ¨ dirty ä¸­ï¼›</li><li>read.m æ›´æ–°æ˜¯åœ¨ missed æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ï¼ˆdirty.lengthï¼‰æ—¶ï¼Œç›´æ¥è¿›è¡ŒåŸå­è¦†ç›–ã€‚<ul><li>ä¸ºä»€ä¹ˆä¸ miss ä¸€æ¬¡è¿›è¡Œä¸€æ¬¡æ›´æ–°ï¼Ÿ</li></ul></li><li>dirty ä¸º nil æƒ…å†µï¼šæœªè¢«ä½¿ç”¨çš„ mapï¼›miss è¶…è¿‡é˜ˆå€¼æ—¶ï¼›</li><li>æŒæœ‰é”æƒ…å†µï¼šä¿®æ”¹ dirtyã€ä¿®æ­£ readï¼›</li><li>çœ‹ä»£ç æ—¶å¯¹ store ä¸­åˆ¤æ–­ï¼Œ<code>entry.unexpungeLocked</code> æ—¶å¯¹ dirty æ‰å†™å…¥ keyã€‚å¯¹è¿™ä¸ªé€»è¾‘æœ‰ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆ entry ä¸º expunged çŠ¶æ€è¯´æ˜ dirty ä¸ä¸º nil ï¼Œå¹¶ä¸”å…¶ä¸­ä¸å­˜åœ¨è¯¥ key å‘¢ï¼Ÿ<ul><li>é€šè¿‡ä¸‹å›¾èƒ½å¤Ÿçœ‹åˆ°ï¼Œenrty åªæœ‰ read.m ä¸ dirty åŒæ­¥é€»è¾‘ä¸­æ‰ä¼šä¿®æ”¹ä¸º expunged; å¹¶ä¸”åŒæ­¥è¿‡ç¨‹ä¸ä¼šåŒæ­¥è¢«åˆ é™¤çš„ keyï¼›æ‰€ä»¥ï¼Œexpunged çŠ¶æ€çš„ key ä¸ä¼šå­˜åœ¨äº dirty ä¸­ã€‚</li><li>å¦‚5ï¼Œdirty map ä¸º nil åªæœ‰ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥åªæœ‰ä¿®æ­£read æƒ…å†µã€‚å› ä¸º read.m ä¸­åŒ…å« keyï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è¿›è¡ŒåŸå­æ›´æ–° readã€‚è¿™æ ·ï¼Œå°±ä¼šå‡ºç° dirty =nil æƒ…å†µï¼›</li></ul></li><li>dirty ä¸­ä¸ä¼šåŒ…å« expunged çŠ¶æ€çš„ entryï¼Œå¹¶ä¸”åŒ…å«æ‰€æœ‰æœ‰æ•ˆ keyï¼›</li></ol><p><img src=/blog/p/golang-sync-map/img/map-entry-state.jpg width=1206 height=1168 srcset="/blog/p/golang-sync-map/img/map-entry-state_hu2f1e02e515e351c311ec896043222feb_220210_480x0_resize_q75_box.jpg 480w, /blog/p/golang-sync-map/img/map-entry-state_hu2f1e02e515e351c311ec896043222feb_220210_1024x0_resize_q75_box.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=103 data-flex-basis=247px></p><h2 id=reference>reference</h2><ol><li><a class=link href=https://purewhite.io/2020/08/24/golang-sync-map-keys-never-delete/ target=_blank rel=noopener>sync.Map å¼•èµ·çš„ bug</a></li><li><a class=link href=https://halfrost.com/go_map_chapter_one/ target=_blank rel=noopener>å¦‚ä½•å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„map</a></li></ol></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/golang-rwmutex-deadlock/><div class=article-image><img src=/blog/p/golang-rwmutex-deadlock/daedlock.15d5d266eb14d23a5c933e1775b8ea74_hu26d071d1a9c611a8342c73b77f908c12_41977_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy alt="Featured image of post GO RWMutex ä¸­éšè—çš„æ­»é”é—®é¢˜" data-key=golang-rwmutex-deadlock data-hash="md5-FdXSZusU0jpckz4XdbjqdA=="></div><div class=article-details><h2 class=article-title>GO RWMutex ä¸­éšè—çš„æ­»é”é—®é¢˜</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 jason's åšå®¢</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>